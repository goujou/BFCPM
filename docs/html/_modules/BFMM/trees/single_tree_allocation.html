<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <!-- Generated with Sphinx 7.0.1 and Furo 2023.05.20 -->
        <title>BFMM.trees.single_tree_allocation - BFMM</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?digest=e6660623a769aa55fea372102b9bf3151b292993" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">BFMM</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  
  <span class="sidebar-brand-text">BFMM</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../BFMM.prepare_stand.html">prepare_stand</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../BFMM.stand.html">stand</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of stand</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../BFMM.stand.Stand.html">Stand</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../BFMM.type_aliases.html">type_aliases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../BFMM.utils.html">utils</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../BFMM.productivity.html">productivity</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../BFMM.trees.html">trees</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of trees</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../BFMM.trees.allometry.html">allometry</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../BFMM.trees.mean_tree.html">mean_tree</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of mean_tree</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.trees.mean_tree.MeanTree.html">MeanTree</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../BFMM.trees.single_tree_C_model.html">single_tree_C_model</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of single_tree_C_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.trees.single_tree_C_model.SingleTreeCModel.html">SingleTreeCModel</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../BFMM.trees.single_tree_allocation.html">single_tree_allocation</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of single_tree_allocation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html">SingleTree</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../BFMM.trees.single_tree_params.html">single_tree_params</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../BFMM.trees.single_tree_vars.html">single_tree_vars</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../BFMM.trees.tree_utils.html">tree_utils</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../BFMM.soil.html">soil</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of soil</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../BFMM.soil.dead_wood_classes.html">dead_wood_classes</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of dead_wood_classes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../BFMM.soil.dead_wood_classes.C_model.html">C_model</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of C_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../BFMM.soil.dead_wood_classes.C_model.SoilCDeadWoodClasses.html">SoilCDeadWoodClasses</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.soil.dead_wood_classes.C_model_parameters.html">C_model_parameters</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../BFMM.soil.simple_soil_model.html">simple_soil_model</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of simple_soil_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../BFMM.soil.simple_soil_model.C_model.html">C_model</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of C_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../BFMM.soil.simple_soil_model.C_model.SimpleSoilCModel.html">SimpleSoilCModel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.soil.simple_soil_model.C_model_parameters.html">C_model_parameters</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../BFMM.soil.soil_c_model_abc.html">soil_c_model_abc</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of soil_c_model_abc</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.soil.soil_c_model_abc.SoilCModelABC.html">SoilCModelABC</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../BFMM.wood_products.html">wood_products</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of wood_products</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../BFMM.wood_products.simple_wood_product_model.html">simple_wood_product_model</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of simple_wood_product_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../BFMM.wood_products.simple_wood_product_model.C_model.html">C_model</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of C_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../BFMM.wood_products.simple_wood_product_model.C_model.SimpleWoodProductModel.html">SimpleWoodProductModel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.wood_products.simple_wood_product_model.C_model_parameters.html">C_model_parameters</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../BFMM.wood_products.wood_product_model_abc.html">wood_product_model_abc</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of wood_product_model_abc</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.wood_products.wood_product_model_abc.WoodProductModelABC.html">WoodProductModelABC</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../BFMM.management.html">management</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of management</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../BFMM.management.library.html">library</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../BFMM.management.management_strategy.html">management_strategy</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of management_strategy</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.Cut.html">Cut</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.CutAndReplant.html">CutAndReplant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.CutWaitAndReplant.html">CutWaitAndReplant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.ManagementActionABC.html">ManagementActionABC</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.ManagementStrategy.html">ManagementStrategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.OnDBHLimit.html">OnDBHLimit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.OnDTHLimit.html">OnDTHLimit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.OnDelayOneTime.html">OnDelayOneTime</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.OnNLimit.html">OnNLimit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.OnPeriodically.html">OnPeriodically</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.OnSBALimit.html">OnSBALimit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.OnSBAvsDTH.html">OnSBAvsDTH</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.OnStandAges.html">OnStandAges</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.OnTimeIntervals.html">OnTimeIntervals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.PCT.html">PCT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.Plant.html">Plant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.Thin.html">Thin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.ThinStand.html">ThinStand</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.TriggerABC.html">TriggerABC</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.management.management_strategy.WaitAndPlant.html">WaitAndPlant</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../BFMM.simulation.html">simulation</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of simulation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../BFMM.simulation.library.html">library</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../BFMM.simulation.recorded_simulation.html">recorded_simulation</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of recorded_simulation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.simulation.recorded_simulation.RecordedSimulation.html">RecordedSimulation</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../BFMM.simulation.simulation.html">simulation</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of simulation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../BFMM.simulation.simulation.Simulation.html">Simulation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../BFMM.simulation.utils.html">utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../BFMM.simulation_parameters.html">simulation_parameters</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Untitled.html">Test notebook</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for BFMM.trees.single_tree_allocation</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains the class</span>
<span class="sd">:class:`~single_tree_allocation.SingleTree`.</span>

<span class="sd">The class combines eco-physiological principles and tree allometries</span>
<span class="sd">to model C allocation to tree organs.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">brentq</span><span class="p">,</span> <span class="n">root</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">zeta_dw</span><span class="p">,</span> <span class="n">zeta_gluc</span>
<span class="kn">from</span> <span class="nn">..type_aliases</span> <span class="kn">import</span> <span class="n">SpeciesParams</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tree_utils</span>
<span class="kn">from</span> <span class="nn">.allometry</span> <span class="kn">import</span> <span class="n">allometries_repola_and_lehtonen</span> <span class="k">as</span> <span class="n">allometries</span>
<span class="kn">from</span> <span class="nn">.single_tree_params</span> <span class="kn">import</span> <span class="n">initialize_params</span><span class="p">,</span> <span class="n">species_params</span>
<span class="kn">from</span> <span class="nn">.single_tree_vars</span> <span class="kn">import</span> <span class="n">assign</span><span class="p">,</span> <span class="n">var_infos</span>

<span class="c1"># from ..utils import cached_property</span>


<div class="viewcode-block" id="TreeShrinkError"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.html#BFMM.trees.single_tree_allocation.TreeShrinkError">[docs]</a><span class="k">class</span> <span class="nc">TreeShrinkError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when the tree wants to shrink its radius at trunk base.</span>

<span class="sd">    This happends when the tree&#39;s :math:`C_S&#39;` pool is too depleted</span>
<span class="sd">    such that the tree cannot survive.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tree_name</span> <span class="o">=</span> <span class="n">tree_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tree_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Name of the tree that raised the problem.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_name</span></div>


<div class="viewcode-block" id="GlucoseBudgetError"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.html#BFMM.trees.single_tree_allocation.GlucoseBudgetError">[docs]</a><span class="k">class</span> <span class="nc">GlucoseBudgetError</span><span class="p">(</span><span class="n">TreeShrinkError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when the glucose budget could not be resolved.</span>

<span class="sd">    This needs to be resolved numerically in order to find the</span>
<span class="sd">    right ``Delta_r`` for radial growth given an amount of available</span>
<span class="sd">    glucose ``E``. It usually does not work when ``E`` is too small, which</span>
<span class="sd">    seems to happen for small spruces in the year after planting.</span>
<span class="sd">    By catching this exception, the stand can make the tree to enjoy</span>
<span class="sd">    another year of doing nothing and collect the captured carbon</span>
<span class="sd">    in ``x[0]`` of the</span>
<span class="sd">    :class:`~single_tree_C_model.SingleTreeCModel`.</span>
<span class="sd">    Next year, next try.</span>

<span class="sd">    Currently not being used.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="SingleTree"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree">[docs]</a><span class="k">class</span> <span class="nc">SingleTree</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Single tree class comprising internal cycling and external allometries.</span>

<span class="sd">    An instance of this class can be used to initialize an instance of</span>
<span class="sd">    :class:`~single_tree_C_model.SingleTreeCModel`</span>
<span class="sd">    which can then be used to initialize an instance of</span>
<span class="sd">    :class:`~.mean_tree.MeanTree` which in turn</span>
<span class="sd">    can be added to a :class:`~.stand.Stand`.</span>

<span class="sd">    Args:</span>
<span class="sd">        species: tree species, element of ``[&quot;pine&quot;, &quot;spruce&quot;, &quot;birch&quot;]``</span>
<span class="sd">        r: radius at trunk base [m]</span>
<span class="sd">        Delta_t: time step [yr]</span>
<span class="sd">        C_S: initial value of ``C_S pool``, required if tree is</span>
<span class="sd">            big enough to have heartwood, otherwise defaults to ``Q_(&quot;0 g_gluc&quot;)``</span>
<span class="sd">        B_TS: initial value of ``B_TS`` pool, optional</span>
<span class="sd">        B_TH: initial value of ``B_TH`` pool, required if tree is</span>
<span class="sd">            big enough to have heartwood, otherwise defaults to ``Q_(&quot;0 g_dw&quot;)``</span>
<span class="sd">        custom_species_params: tree species parameters (for all species)</span>
<span class="sd">        tree_age: age of the tree [yr]</span>
<span class="sd">        tol: absolute tolerance in check for self-consistency</span>

<span class="sd">    Attributes:</span>
<span class="sd">        species: element of ``[&quot;pine&quot;, &quot;spruce&quot;, &quot;birch&quot;]``</span>
<span class="sd">        r (Q_[float]): radius at trunk base [m]</span>
<span class="sd">        Delta_t (Q_[float]): time step [yr]</span>
<span class="sd">        params (dict[str, Any]): tree parameters, mostly allometric</span>
<span class="sd">        tol (float): absolute tolerance in check for self-consistency [-]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">r</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">Delta_t</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1 yr&quot;</span><span class="p">),</span>
        <span class="n">C_S</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">B_TS</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">B_TH</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_species_params</span><span class="p">:</span> <span class="n">SpeciesParams</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tree_age</span><span class="o">=</span><span class="n">Q_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;yr&quot;</span><span class="p">),</span>
        <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-08</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_status</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">species</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot create a tree with radius zero.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">custom_species_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">initialize_params</span><span class="p">(</span><span class="n">species_params</span><span class="p">[</span><span class="n">species</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span> <span class="o">=</span> <span class="n">species_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">initialize_params</span><span class="p">(</span><span class="n">custom_species_params</span><span class="p">[</span><span class="n">species</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span> <span class="o">=</span> <span class="n">custom_species_params</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span> <span class="o">=</span> <span class="n">Delta_t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_age</span> <span class="o">=</span> <span class="n">tree_age</span>

        <span class="n">dbh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbh</span>
        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">B_TS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TH</span> <span class="o">!=</span> <span class="n">Q_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;m^3&quot;</span><span class="p">):</span>  <span class="c1"># pylint: disable=comparison-with-callable</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Tree too big to be initialized.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_TH&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span> <span class="o">=</span> <span class="n">B_TH</span>

        <span class="c1"># compute initial B_TS and C_S</span>

        <span class="c1"># this is how it would be done following Ogle and Pacala</span>
        <span class="c1"># unfortunately, the results do not match allometric equations</span>
        <span class="k">if</span> <span class="n">B_TS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#            rho_W0 = self.compute_rho_W(</span>
            <span class="c1">#                dbh, H, Q_(&quot;0.0 m&quot;)</span>
            <span class="c1">#            )  # , Delta_V_TH=Q_(0, &quot;m^3&quot;))</span>

            <span class="c1"># make sure C_S_star &gt;= 0, multiply with 0.5 to have at leas some C_S at the beginning</span>
            <span class="n">rho_W0</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;rho_W&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma_X&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma_W&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">rho_W0</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">rho_W0</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_TS</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_TS</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_TS&quot;</span><span class="p">,</span> <span class="n">rho_W0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TS</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span> <span class="o">=</span> <span class="n">B_TS</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SW</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;SW&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_age</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">C_S</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;C_S&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S_star</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">=</span> <span class="n">C_S</span>

        <span class="c1"># living sapwood biomass, depends on B_TS and V_TS</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_S_star</span> <span class="o">&gt;=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>

        <span class="c1"># store initial dbh for potential replanting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_dbh</span><span class="p">:</span> <span class="n">Q_</span> <span class="o">=</span> <span class="n">dbh</span>

<div class="viewcode-block" id="SingleTree.from_dbh"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.from_dbh">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dbh</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">Delta_t</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1 yr&quot;</span><span class="p">),</span>
        <span class="n">C_S</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">B_TS</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">B_TH</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_species_params</span><span class="p">:</span> <span class="n">SpeciesParams</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tree_age</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;yr&quot;</span><span class="p">),</span>
        <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-08</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor from dbh instead of r.</span>

<span class="sd">        Args:</span>
<span class="sd">            species: element of [&quot;pine&quot;, &quot;spruce&quot;, &quot;birch&quot;]</span>
<span class="sd">            dbh: diameter at breast height [cm]</span>
<span class="sd">            Delta_t: time step [yr]</span>
<span class="sd">            C_S: initial value of ``C_S pool``, required if tree is</span>
<span class="sd">                big enough to have heartwood, otherwise defaults to ``Q_(&quot;0 g_gluc&quot;)``</span>
<span class="sd">            B_TS: initial value of ``B_TS`` pool, optional</span>
<span class="sd">            B_TH: initial value of ``B_TH`` pool, required if tree is</span>
<span class="sd">                big enough to have heartwood, otherwise defaults to ``Q_(&quot;0 g_dw&quot;)``</span>
<span class="sd">            custom_species_params: tree species parameters (for all species)</span>
<span class="sd">            tree_age: age of the tree [yr]</span>
<span class="sd">            tol: absolute tolerance in check for self-consistency [-]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">custom_species_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">custom_species_params</span> <span class="o">=</span> <span class="n">initialize_params</span><span class="p">(</span><span class="n">species_params</span><span class="p">[</span><span class="n">species</span><span class="p">])</span>

        <span class="n">dbh_cm</span> <span class="o">=</span> <span class="n">dbh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">r_at_trunk_base</span> <span class="o">=</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">r_from_dbh</span><span class="p">(</span><span class="n">dbh_cm</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">custom_species_params</span><span class="p">)</span>

        <span class="n">check_dbh_cm</span> <span class="o">=</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">dbh_from_r</span><span class="p">(</span>
            <span class="n">r_at_trunk_base</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">custom_species_params</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dbh_cm</span> <span class="o">-</span> <span class="n">check_dbh_cm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-08</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">species</span><span class="p">,</span>
            <span class="n">r_at_trunk_base</span><span class="p">,</span>
            <span class="n">Delta_t</span><span class="o">=</span><span class="n">Delta_t</span><span class="p">,</span>
            <span class="n">C_S</span><span class="o">=</span><span class="n">C_S</span><span class="p">,</span>
            <span class="n">B_TS</span><span class="o">=</span><span class="n">B_TS</span><span class="p">,</span>
            <span class="n">B_TH</span><span class="o">=</span><span class="n">B_TH</span><span class="p">,</span>
            <span class="n">custom_species_params</span><span class="o">=</span><span class="n">custom_species_params</span><span class="p">,</span>
            <span class="n">tree_age</span><span class="o">=</span><span class="n">tree_age</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.from_mleaf"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.from_mleaf">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_mleaf</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mleaf</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">Delta_t</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1 yr&quot;</span><span class="p">),</span>
        <span class="n">C_S</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">B_TS</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">B_TH</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_species_params</span><span class="p">:</span> <span class="n">SpeciesParams</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tree_age</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;yr&quot;</span><span class="p">),</span>
        <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-08</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SingleTree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a class instant based on leaf biomass.</span>

<span class="sd">        Args:</span>
<span class="sd">            species: tree species, element of [&quot;pine&quot;, &quot;spruce&quot;, &quot;birch&quot;]</span>
<span class="sd">            mleaf: leaf biomass [g_dw]</span>
<span class="sd">            Delta_t: time step [yr]</span>
<span class="sd">            C_S: initial value of ``C_S pool``, required if tree is</span>
<span class="sd">                big enough to have heartwood, otherwise defaults to ``Q_(&quot;0 g_gluc&quot;)``</span>
<span class="sd">            B_TS: initial value of ``B_TS`` pool, optional</span>
<span class="sd">            B_TH: initial value of ``B_TH`` pool, required if tree is</span>
<span class="sd">                big enough to have heartwood, otherwise defaults to ``Q_(&quot;0 g_dw&quot;)``</span>
<span class="sd">            custom_species_params: tree species parameters (for all species)</span>
<span class="sd">            tree_age: age of the tree [yr]</span>
<span class="sd">            tol: absolute tolerance in check for self-consistency [-]</span>

<span class="sd">        Returns:</span>
<span class="sd">            class instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">custom_species_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">custom_species_params</span> <span class="o">=</span> <span class="n">initialize_params</span><span class="p">(</span><span class="n">species_params</span><span class="p">[</span><span class="n">species</span><span class="p">])</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">tree_utils</span><span class="o">.</span><span class="n">r_from_mleaf</span><span class="p">(</span>
                <span class="n">mleaf</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;kg_dw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="n">species</span><span class="p">,</span>
                <span class="n">allometries</span><span class="p">,</span>
                <span class="n">custom_species_params</span><span class="o">=</span><span class="n">custom_species_params</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">species</span><span class="p">,</span>
            <span class="n">r</span><span class="p">,</span>
            <span class="n">Delta_t</span><span class="o">=</span><span class="n">Delta_t</span><span class="p">,</span>
            <span class="n">C_S</span><span class="o">=</span><span class="n">C_S</span><span class="p">,</span>
            <span class="n">B_TS</span><span class="o">=</span><span class="n">B_TS</span><span class="p">,</span>
            <span class="n">B_TH</span><span class="o">=</span><span class="n">B_TH</span><span class="p">,</span>
            <span class="n">custom_species_params</span><span class="o">=</span><span class="n">custom_species_params</span><span class="p">,</span>
            <span class="n">tree_age</span><span class="o">=</span><span class="n">tree_age</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span></div>

<div class="viewcode-block" id="SingleTree.clear_cache"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.clear_cache">[docs]</a>    <span class="k">def</span> <span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the cache.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Single tree type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;dbh: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="si">:</span><span class="s2">~.4</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;height: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="si">:</span><span class="s2">~.4</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<div class="viewcode-block" id="SingleTree.lad_normed"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.lad_normed">[docs]</a>    <span class="k">def</span> <span class="nf">lad_normed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalized leaf area density [m2 m-1] over grid ``z``, integrates to 1.</span>

<span class="sd">        Args:</span>
<span class="sd">            z: grid of tree height layer boundaries [m]</span>

<span class="sd">        Returns:</span>
<span class="sd">            normalized leaf area density of grid ``z``, [m-1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lad_n</span> <span class="o">=</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">lad_normed_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># pylint: disable=no-member</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Q_</span><span class="p">(</span><span class="n">lad_n</span><span class="p">,</span> <span class="s2">&quot;1/m&quot;</span><span class="p">)</span></div>

    <span class="c1">###########################################################################</span>

<div class="viewcode-block" id="SingleTree.solve_glucose_budget"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.solve_glucose_budget">[docs]</a>    <span class="k">def</span> <span class="nf">solve_glucose_budget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dr</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">E</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">tree_status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span>
        <span class="n">tree_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimization function based on the radius change ``dr``.</span>

<span class="sd">        The goal is to choose ``dr`` such that ``Anet_gluc`` is used up</span>
<span class="sd">        during the tree&#39;s structural update, based on its allometries.</span>

<span class="sd">        Args:</span>
<span class="sd">            dr: potential change in tree radius ``r`` at trunk base [m]</span>
<span class="sd">            E: parameter of available glucose to distribute [g_gluc yr-1]</span>
<span class="sd">            tree_status: if &quot;static&quot; or &quot;shrinking&quot;, no trunk growth</span>
<span class="sd">            tree_init: if True, we are still in the planting process</span>

<span class="sd">        Returns:</span>
<span class="sd">            res: relative discrepancy in carbon budget [-]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="s2">&quot;_value&quot;</span><span class="p">,</span> <span class="n">dr</span><span class="p">))</span>  <span class="c1"># it might come in as a one-element array</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">tree_init</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">dr</span>

        <span class="n">Delta_r</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;Delta_r&quot;</span><span class="p">,</span> <span class="n">dr</span><span class="p">)</span>
        <span class="n">next_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">+</span> <span class="n">Delta_r</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_with_next_r</span><span class="p">(</span><span class="n">next_r</span><span class="p">,</span> <span class="n">tree_status</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># don&#39;t stop trying to solve the glucose budget</span>
            <span class="c1"># just the currently tried r is technically too small</span>
            <span class="c1"># to compute the dbh, try another one, dont give up completely</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">Delta_r</span><span class="o">.</span><span class="n">magnitude</span> <span class="k">if</span> <span class="n">Delta_r</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">f_L_times_E</span><span class="p">,</span> <span class="n">f_R_times_E</span><span class="p">,</span> <span class="n">f_T_times_E</span><span class="p">,</span> <span class="n">f_O_times_E</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tup</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">E</span> <span class="o">-</span> <span class="n">f_L_times_E</span> <span class="o">-</span> <span class="n">f_R_times_E</span> <span class="o">-</span> <span class="n">f_T_times_E</span> <span class="o">-</span> <span class="n">f_O_times_E</span>

        <span class="c1">#        res /= E # seems way more robust # or not?</span>
        <span class="c1">#        print(367, dr, E, res)</span>
        <span class="c1">#        print(f_L_times_E, f_R_times_E, f_T_times_E, f_O_times_E)</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">magnitude</span></div>

<div class="viewcode-block" id="SingleTree.minimum_E_to_resolve_C_budget"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.minimum_E_to_resolve_C_budget">[docs]</a>    <span class="k">def</span> <span class="nf">minimum_E_to_resolve_C_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the minimum amount of glucose to resolve budget.</span>

<span class="sd">        During initialization of the associated</span>
<span class="sd">        :class:`~.single_tree_C_model.SingleTreeCModel`</span>
<span class="sd">        a minimum amount of ``E`` is necessary to resolve the glucose budget</span>
<span class="sd">        in the first time step when there are yet no inputs by photosynthesis.</span>
<span class="sd">        So this method is called to determine how much ``E`` (glucose) is needed</span>
<span class="sd">        such that the tree can resolve its C budget for its first radial growth.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ``E[0]``: initially needed amount for first radial growth [g_gluc yr-1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># clear cache before computations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">E</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">E</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1000</span>

            <span class="n">_Delta_r</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_Delta_r&quot;</span><span class="p">,</span> <span class="n">Q_</span><span class="p">(</span><span class="mf">1e-02</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">root_results</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">solve_glucose_budget</span><span class="p">,</span>
                    <span class="n">x0</span><span class="o">=</span><span class="n">_Delta_r</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">Q_</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="s2">&quot;g_gluc/yr&quot;</span><span class="p">),</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">root_results</span><span class="o">.</span><span class="n">x</span>
                <span class="n">success</span> <span class="o">=</span> <span class="n">root_results</span><span class="o">.</span><span class="n">success</span>
                <span class="n">fun</span> <span class="o">=</span> <span class="n">root_results</span><span class="o">.</span><span class="n">fun</span>

            <span class="c1">#                res, root_results = brentq(</span>
            <span class="c1">#                    self.solve_glucose_budget,</span>
            <span class="c1">#                    -0.05,</span>
            <span class="c1">#                    0.05,</span>
            <span class="c1">#                    args=(E, &quot;healthy&quot;, True),</span>
            <span class="c1">##                    xtol=1e-05,</span>
            <span class="c1">##                    rtol=1e-05,</span>
            <span class="c1">#                    full_output=True,</span>
            <span class="c1">#                )</span>
            <span class="c1">#                success = root_results.converged</span>
            <span class="c1">#                print(res, E)</span>
            <span class="c1">#                print(root_results)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1000</span>

            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">success</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-03</span><span class="p">):</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">2000</span>

            <span class="n">Delta_r</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;Delta_r&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
            <span class="c1">#            print(&quot;E&quot;, E, &quot;Delta_r&quot;, Delta_r, Delta_r/self.r)</span>
            <span class="c1"># The 0.01 here are super arbitrary but seem to work</span>
            <span class="c1"># at the moment. With a previous spinup version 0.02 worked</span>
            <span class="c1"># and with the current spinup 0.02 does not work anymore.</span>
            <span class="k">if</span> <span class="n">Delta_r</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># or (Delta_r &lt; Q_(&quot;0.01 cm&quot;)):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">Delta_r</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="o">-</span><span class="n">Delta_r</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>

        <span class="n">E1</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># g_gluc/yr</span>
        <span class="k">while</span> <span class="n">g</span><span class="p">(</span><span class="n">E1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">E1</span> <span class="o">*=</span> <span class="mi">2</span>

        <span class="n">E0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">res</span><span class="p">,</span> <span class="n">root_results</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">E0</span><span class="p">,</span> <span class="n">E1</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root_results</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GlucoseBudgetError</span>

        <span class="k">return</span> <span class="n">Q_</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s2">&quot;g_gluc/yr&quot;</span><span class="p">)</span></div>

    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_update_with_next_r</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">next_r</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">tree_status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal method used to find the right next ``r``.</span>

<span class="sd">        The return values will be used in the nonlinear optimization</span>
<span class="sd">        to find the right trunk growth ``Delta_r`` such that the</span>
<span class="sd">        photosynthetically captured glucose is optimally used.</span>

<span class="sd">        Args:</span>
<span class="sd">            next_r: potential radius at trunk base of next year&#39;s tree[m]</span>
<span class="sd">            tree_status: if &quot;static&quot; or &quot;shrinking&quot;, no trunk growth</span>

<span class="sd">        Returns: tuple containing</span>

<span class="sd">            - f_L_times_E: glucose allocated to leaves [g_gluc yr-1]</span>
<span class="sd">            - f_R_times_E: glucose allocated to fine roots [g_gluc yr-1]</span>
<span class="sd">            - f_T_times_E: glucose allocated to trunk [g_gluc yr-1]</span>
<span class="sd">            - f_O_times_E: glucose allocated to other [g_gluc yr-1]</span>
<span class="sd">            - v_T: rate of trunk heartwood production from sapwood [yr-1]</span>
<span class="sd">            - v_O: rate of other heartwood production from sapwood [yr-1]</span>
<span class="sd">            - Delta_B_TH: growth in trunk heartwood biomass [g_dw]</span>
<span class="sd">            - Delta_B_TS: growth in trunk sapwood biomass [g_dw]</span>
<span class="sd">            - rho_W: density of newly produced sapwood [g_dw m-3]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#        print(&quot;_update_with_next_r&quot;)</span>
        <span class="c1">#        print(next_r, tree_status, self.tree_age)</span>

        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="n">next_dbh</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">tree_utils</span><span class="o">.</span><span class="n">dbh_from_r</span><span class="p">(</span>
                <span class="n">next_r</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span>
            <span class="p">),</span>
            <span class="s2">&quot;cm&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">next_dbh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;next_dbh &lt; 0&quot;</span><span class="p">)</span>

        <span class="n">next_H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">)</span>

        <span class="n">next_B_L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_L_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">,</span> <span class="n">next_H</span><span class="p">)</span>
        <span class="n">f_L_times_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_f_L_times_E</span><span class="p">(</span><span class="n">next_B_L</span><span class="p">)</span>

        <span class="n">next_B_R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_R_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">,</span> <span class="n">next_H</span><span class="p">)</span>
        <span class="n">f_R_times_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_f_R_times_E</span><span class="p">(</span><span class="n">next_B_R</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tree_status</span> <span class="o">==</span> <span class="s2">&quot;healthy&quot;</span><span class="p">:</span>
            <span class="n">next_SW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW_func</span><span class="p">(</span><span class="n">next_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_age</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_SW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW</span>
        <span class="c1">#        print(482, &quot;next_SW&quot;, next_SW)</span>

        <span class="n">next_V_TH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TH_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">,</span> <span class="n">next_H</span><span class="p">,</span> <span class="n">next_SW</span><span class="p">)</span>
        <span class="n">v_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_v_T</span><span class="p">(</span><span class="n">next_V_TH</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tree_status</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="s2">&quot;shrinking&quot;</span><span class="p">]:</span>
            <span class="c1"># no sapwood to heartwood conversion</span>
            <span class="n">v_T</span> <span class="o">*=</span> <span class="mi">0</span>

        <span class="n">next_V_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">,</span> <span class="n">next_H</span><span class="p">)</span>

        <span class="c1">#            Delta_V_TH = next_V_TH - self.V_TH</span>
        <span class="n">Delta_r</span> <span class="o">=</span> <span class="n">next_r</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span>
        <span class="n">rho_W_healthy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rho_W</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">,</span> <span class="n">next_H</span><span class="p">,</span> <span class="n">Delta_r</span><span class="p">)</span>  <span class="c1"># , Delta_V_TH)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tree_status</span> <span class="o">==</span> <span class="s2">&quot;healthy&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">next_dbh</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">):</span>
            <span class="n">rho_W</span> <span class="o">=</span> <span class="n">rho_W_healthy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if the density is too low, then sum(f_X) might be &gt; 1 even though</span>
            <span class="c1"># in healthy state the tree wants to shrink, then we would</span>
            <span class="c1"># have a negative flux f_CS, which leads to problems</span>
            <span class="c1">#            rho_W = np.maximum(self._rho_W, rho_W_healthy)</span>
            <span class="n">rho_W</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_rho_W&quot;</span><span class="p">,</span> <span class="n">rho_W_healthy</span><span class="p">)</span>
        <span class="c1">#            print(</span>
        <span class="c1">#                480,</span>
        <span class="c1">#                &quot;rho_W&quot;,</span>
        <span class="c1">#                tree_status,</span>
        <span class="c1">#                rho_W,</span>
        <span class="c1">#                rho_W_healthy,</span>
        <span class="c1">#                getattr(self, &quot;_rho_W&quot;, &quot;no _rho_W&quot;),</span>
        <span class="c1">#            )</span>

        <span class="n">delta_W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_delta_W</span><span class="p">(</span><span class="n">rho_W</span><span class="p">)</span>
        <span class="n">f_T_times_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_f_T_times_E</span><span class="p">(</span><span class="n">v_T</span><span class="p">,</span> <span class="n">next_V_T</span><span class="p">,</span> <span class="n">rho_W</span><span class="p">,</span> <span class="n">delta_W</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tree_status</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="s2">&quot;shrinking&quot;</span><span class="p">]:</span>
            <span class="n">f_T_times_E</span> <span class="o">*=</span> <span class="mi">0</span>

        <span class="n">delta_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_S</span>
        <span class="n">Delta_B_TH</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">delta_S</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gHW&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">v_T</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
        <span class="p">)</span>
        <span class="n">next_B_TH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span> <span class="o">+</span> <span class="n">Delta_B_TH</span>

        <span class="n">Delta_B_TS</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">f_T_times_E</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_W</span><span class="p">)</span> <span class="o">-</span> <span class="n">v_T</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
        <span class="n">next_B_TS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span> <span class="o">+</span> <span class="n">Delta_B_TS</span>

        <span class="n">next_B_OH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OH_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">,</span> <span class="n">next_H</span><span class="p">,</span> <span class="n">next_B_TH</span><span class="p">)</span>
        <span class="n">v_O</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_v_O</span><span class="p">(</span><span class="n">next_B_OH</span><span class="p">)</span>

        <span class="n">next_B_OS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OS_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">,</span> <span class="n">next_H</span><span class="p">,</span> <span class="n">next_B_TS</span><span class="p">)</span>
        <span class="n">f_O_times_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_f_O_times_E</span><span class="p">(</span><span class="n">v_O</span><span class="p">,</span> <span class="n">next_B_OS</span><span class="p">,</span> <span class="n">delta_W</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">f_L_times_E</span><span class="p">,</span>
            <span class="n">f_R_times_E</span><span class="p">,</span>
            <span class="n">f_T_times_E</span><span class="p">,</span>
            <span class="n">f_O_times_E</span><span class="p">,</span>
            <span class="n">v_T</span><span class="p">,</span>
            <span class="n">v_O</span><span class="p">,</span>
            <span class="n">Delta_B_TH</span><span class="p">,</span>
            <span class="n">Delta_B_TS</span><span class="p">,</span>
            <span class="n">rho_W</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SingleTree.update"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.update">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[mass_glucose]/[time]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the tree according to the acccumulated incoming ``E=A_net``.</span>

<span class="sd">        Args:</span>
<span class="sd">            E: incoming accumulated net radiation as glucose [g_gluc/yr]</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of fluxes and rates.</span>

<span class="sd">            - f_L_times_E (Q_[float]): glucose allocated to leaves [g_gluc yr-1]</span>
<span class="sd">            - f_R_times_E (Q_[float]): glucose allocated to fine roots [g_gluc yr-1]</span>
<span class="sd">            - f_O_times_E (Q_[float]): glucose allocated to coarse roots and branches [g_gluc yr-1]</span>
<span class="sd">            - f_T_times_E Q_[float]: glucose allocated to trunk [g_gluc]</span>
<span class="sd">            - v_O (Q_[float]): sapwood to heartwood conversion rate</span>
<span class="sd">                of coarse roots and branches [yr-1]</span>
<span class="sd">            - v_T (Q_[float]): sapwood to heartwood conversion rate</span>
<span class="sd">                of the trunk [yr-1]</span>
<span class="sd">            - delta_W Q_[float]): maximum labile C storage capacity of</span>
<span class="sd">                newly produces sapwood [g_gluc/g_dw]</span>
<span class="sd">            - f_CS_times_CS (Q_[float]): in &quot;static&quot; and &quot;shrinking&quot; state amount of glucose used</span>
<span class="sd">                from storage [g_gluc yr-1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="c1"># clear cache before computations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>

        <span class="n">tree_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_status</span>

        <span class="c1"># solve for Delta_r to equalize glucose budget</span>

        <span class="c1">#        _, root_res = brentq(self.solve_glucose_budget, 0, 1, full_output=True)</span>
        <span class="c1">#        print(root_res)</span>

        <span class="n">_Delta_r</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_Delta_r&quot;</span><span class="p">,</span> <span class="n">Q_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">_Delta_r</span> <span class="o">==</span> <span class="n">Q_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">):</span>
            <span class="n">_Delta_r</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span>

        <span class="n">root_results</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_glucose_budget</span><span class="p">,</span>
            <span class="n">x0</span><span class="o">=</span><span class="n">_Delta_r</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
            <span class="c1"># healthy is important here, we want the theoretically optimal result</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="c1"># xtol=1e-05,</span>
            <span class="c1">#            args=(E, tree_status)</span>
            <span class="c1">#            method=&quot;lm&quot; # don&#39;t use it, it&#39;s search ends with crazy results</span>
        <span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">root_results</span><span class="o">.</span><span class="n">x</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">root_results</span><span class="o">.</span><span class="n">success</span>
        <span class="n">Delta_r</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;Delta_r&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">601</span><span class="p">,</span> <span class="n">Delta_r</span><span class="p">,</span> <span class="n">success</span><span class="p">)</span>

        <span class="n">coefficient_sum_tol</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">next_r_healthy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">+</span> <span class="n">Delta_r</span>
            <span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_with_next_r</span><span class="p">(</span><span class="n">next_r_healthy</span><span class="p">,</span> <span class="n">tree_status</span><span class="o">=</span><span class="s2">&quot;healthy&quot;</span><span class="p">)</span>
            <span class="p">(</span>
                <span class="n">f_L_times_E</span><span class="p">,</span>
                <span class="n">f_R_times_E</span><span class="p">,</span>
                <span class="n">f_T_times_E</span><span class="p">,</span>
                <span class="n">f_O_times_E</span><span class="p">,</span>
                <span class="n">v_T</span><span class="p">,</span>
                <span class="n">v_O</span><span class="p">,</span>
                <span class="n">Delta_B_TH</span><span class="p">,</span>
                <span class="n">Delta_B_TS</span><span class="p">,</span>
                <span class="n">_</span><span class="p">,</span>  <span class="c1"># rho_W</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>
            <span class="nb">print</span><span class="p">(</span><span class="mi">620</span><span class="p">,</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="n">tup</span><span class="p">)</span>

            <span class="n">fraction_E_required_for_healthy</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">f_L_times_E</span> <span class="o">+</span> <span class="n">f_R_times_E</span> <span class="o">+</span> <span class="n">f_T_times_E</span> <span class="o">+</span> <span class="n">f_O_times_E</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">E</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fraction_E_required_for_healthy</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">coefficient_sum_tol</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># just in case, give it a second shot</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="mi">603</span><span class="p">,</span> <span class="s2">&quot;&#39;root&#39; did not converge&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">root_results</span><span class="p">)</span>
            <span class="c1"># maybe remove tolerances?</span>
            <span class="c1"># Why the hell does it say it converged</span>
            <span class="c1"># when it is actually far away from a root?</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">root_results</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solve_glucose_budget</span><span class="p">,</span>
                <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span>
                <span class="mf">0.05</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span>
                <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span>
                <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">root_results</span><span class="o">.</span><span class="n">converged</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">success</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">root_results</span><span class="p">)</span>

        <span class="n">Delta_r</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;Delta_r&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

        <span class="n">next_r_healthy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">+</span> <span class="n">Delta_r</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_with_next_r</span><span class="p">(</span><span class="n">next_r_healthy</span><span class="p">,</span> <span class="n">tree_status</span><span class="o">=</span><span class="s2">&quot;healthy&quot;</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="n">f_L_times_E</span><span class="p">,</span>
            <span class="n">f_R_times_E</span><span class="p">,</span>
            <span class="n">f_T_times_E</span><span class="p">,</span>
            <span class="n">f_O_times_E</span><span class="p">,</span>
            <span class="n">v_T</span><span class="p">,</span>
            <span class="n">v_O</span><span class="p">,</span>
            <span class="n">Delta_B_TH</span><span class="p">,</span>
            <span class="n">Delta_B_TS</span><span class="p">,</span>
            <span class="n">rho_W</span><span class="p">,</span>  <span class="c1"># rho_W</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>
        <span class="c1">#        print(661, &quot;healthy&quot;, tup)</span>
        <span class="k">if</span> <span class="n">rho_W</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">rho_W</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="mi">663</span><span class="p">,</span> <span class="s2">&quot;negative wood density&quot;</span><span class="p">,</span> <span class="n">rho_W</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">fraction_E_required_for_healthy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">f_L_times_E</span> <span class="o">+</span> <span class="n">f_R_times_E</span> <span class="o">+</span> <span class="n">f_T_times_E</span> <span class="o">+</span> <span class="n">f_O_times_E</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">E</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fraction_E_required_for_healthy</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">coefficient_sum_tol</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No convergence!&quot;</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="nb">print</span><span class="p">(</span><span class="mi">674</span><span class="p">,</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">fraction_E_required_for_healthy</span><span class="p">,</span> <span class="n">success</span><span class="p">)</span>
        <span class="c1">#        print(tree_status, tup)</span>

        <span class="c1">#        from scipy.optimize import minimize, Bounds</span>
        <span class="c1">#        root_res = minimize(</span>
        <span class="c1">#            self.solve_glucose_budget,</span>
        <span class="c1">#            x0=np.array([_Delta_r.magnitude]),</span>
        <span class="c1">#            bounds=Bounds(np.array([0]), np.array([np.inf]), keep_feasible=True),</span>
        <span class="c1">#            method=&quot;L-BFGS-B&quot;,# SLSQP</span>
        <span class="c1">##Powell</span>
        <span class="c1">##CG</span>
        <span class="c1">##Newton-CG</span>
        <span class="c1">##TNC</span>
        <span class="c1">##COBYLA</span>
        <span class="c1">##SLSQP</span>
        <span class="c1">##trust-constr</span>
        <span class="c1">##dogleg</span>
        <span class="c1">##trust-ncg</span>
        <span class="c1">##trust-exact</span>
        <span class="c1">##trust-krylov</span>
        <span class="c1">#        )</span>
        <span class="c1">#        print(root_res)</span>

        <span class="c1">#        if (not root_res.success) and (np.abs(root_res.fun) &gt; 1e-02) :</span>
        <span class="c1">##        if (not root_res.success) and (np.abs(root_res.fun) &gt; 0.1) :</span>
        <span class="c1">##        if not root_res.converged:</span>
        <span class="c1">#            print(root_res)</span>
        <span class="c1">#            raise ValueError(&quot;Glucose budget could not be resolved.&quot;)</span>
        <span class="c1">##            raise GlucoseBudgetError()</span>

        <span class="c1">#        Delta_r = assign(&quot;Delta_r&quot;, float(root_res.x))</span>

        <span class="c1">#        if (Delta_r &lt;= 0) or (fraction_E_required_for_healthy &gt; 1.1):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Delta_r</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">success</span><span class="p">):</span>
            <span class="n">dbh</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dbh&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tree wants to shrink! H=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="si">}</span><span class="s2">, dbh=</span><span class="si">{</span><span class="n">dbh</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">Delta_r</span><span class="p">,</span> <span class="n">fraction_E_required_for_healthy</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;710, healthy&quot;</span><span class="p">,</span> <span class="n">tup</span><span class="p">)</span>
            <span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_with_next_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">tree_status</span><span class="o">=</span><span class="s2">&quot;static&quot;</span><span class="p">)</span>
            <span class="p">(</span>
                <span class="n">f_L_times_E</span><span class="p">,</span>
                <span class="n">f_R_times_E</span><span class="p">,</span>
                <span class="n">f_T_times_E</span><span class="p">,</span>
                <span class="n">f_O_times_E</span><span class="p">,</span>
                <span class="n">v_T</span><span class="p">,</span>
                <span class="n">v_O</span><span class="p">,</span>
                <span class="n">Delta_B_TH</span><span class="p">,</span>
                <span class="n">Delta_B_TS</span><span class="p">,</span>
                <span class="n">_</span><span class="p">,</span>  <span class="c1"># rho_W</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>
            <span class="nb">print</span><span class="p">(</span><span class="mi">723</span><span class="p">,</span> <span class="n">tree_status</span><span class="p">,</span> <span class="n">tup</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">f_T_times_E</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trunk should not get anything.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">E</span> <span class="o">-</span> <span class="n">f_L_times_E</span> <span class="o">-</span> <span class="n">f_R_times_E</span> <span class="o">-</span> <span class="n">f_O_times_E</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># for instance, tree is in &quot;static&quot; from last year and now cannot</span>
                <span class="c1"># find a Delta_r for growth, root search returns Delta_r = 0,</span>
                <span class="c1"># but fraction_E_required_for_healthy &lt; 1</span>
                <span class="c1"># there is some E still available! What to do with it?</span>
                <span class="c1">#                raise ValueError(&quot;Tree is not really trying to shrink??&quot;)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Some C is kept in E, it cannot be used now for growth.&quot;</span><span class="p">)</span>

            <span class="n">tree_status</span> <span class="o">=</span> <span class="s2">&quot;static&quot;</span>
            <span class="n">Delta_r</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">Delta_r</span>

            <span class="k">if</span> <span class="n">E</span> <span class="o">&lt;</span> <span class="n">f_L_times_E</span> <span class="o">+</span> <span class="n">f_R_times_E</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Not enough E to support leaves and roots, losing leaves and roots.&quot;</span>
                <span class="p">)</span>
                <span class="n">tree_status</span> <span class="o">=</span> <span class="s2">&quot;shrinking&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tree_status</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>

        <span class="n">next_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">+</span> <span class="n">Delta_r</span>
        <span class="n">next_dbh</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">tree_utils</span><span class="o">.</span><span class="n">dbh_from_r</span><span class="p">(</span>
                <span class="n">next_r</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span>
            <span class="p">),</span>
            <span class="s2">&quot;cm&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># double check the found next_dbh</span>
        <span class="n">check_r</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">tree_utils</span><span class="o">.</span><span class="n">r_from_dbh</span><span class="p">(</span>
                <span class="n">next_dbh</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span>
            <span class="p">),</span>
            <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">next_r</span> <span class="o">-</span> <span class="n">check_r</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Q_</span><span class="p">(</span><span class="mf">1e-08</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span>

        <span class="c1"># there was an error in the H_TH formula in the SD</span>
        <span class="c1"># of Ogle and Pacala, can in special situations be caught by:</span>
        <span class="n">next_H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tree_status</span> <span class="o">==</span> <span class="s2">&quot;healthy&quot;</span><span class="p">:</span>
            <span class="n">next_SW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW_func</span><span class="p">(</span><span class="n">next_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_age</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_SW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW</span>
        <span class="n">next_H_TH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_TH_func</span><span class="p">(</span><span class="n">next_r</span><span class="p">,</span> <span class="n">next_H</span><span class="p">,</span> <span class="n">next_SW</span><span class="p">)</span>
        <span class="n">next_V_TH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TH_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">,</span> <span class="n">next_H</span><span class="p">,</span> <span class="n">next_SW</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_TH</span> <span class="o">&lt;=</span> <span class="n">next_H_TH</span> <span class="o">+</span> <span class="n">Q_</span><span class="p">(</span><span class="mf">1e-05</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TH</span> <span class="o">&gt;</span> <span class="n">next_V_TH</span> <span class="o">+</span> <span class="n">Q_</span><span class="p">(</span><span class="mf">1e-05</span><span class="p">,</span> <span class="s2">&quot;m^3&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="mi">709</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">,</span> <span class="n">next_dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">next_H</span><span class="p">)</span>
            <span class="n">next_V_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">,</span> <span class="n">next_H</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">,</span> <span class="n">next_V_T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TH</span><span class="p">,</span> <span class="n">next_V_TH</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TH</span> <span class="o">&lt;=</span> <span class="n">next_V_TH</span> <span class="o">+</span> <span class="n">Q_</span><span class="p">(</span><span class="mf">1e-05</span><span class="p">,</span> <span class="s2">&quot;m^3&quot;</span><span class="p">)</span>

        <span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_with_next_r</span><span class="p">(</span><span class="n">next_r</span><span class="p">,</span> <span class="n">tree_status</span><span class="o">=</span><span class="n">tree_status</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="n">f_L_times_E</span><span class="p">,</span>
            <span class="n">f_R_times_E</span><span class="p">,</span>
            <span class="n">f_T_times_E</span><span class="p">,</span>
            <span class="n">f_O_times_E</span><span class="p">,</span>
            <span class="n">v_T</span><span class="p">,</span>
            <span class="n">v_O</span><span class="p">,</span>
            <span class="n">Delta_B_TH</span><span class="p">,</span>
            <span class="n">Delta_B_TS</span><span class="p">,</span>
            <span class="n">rho_W</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>
        <span class="c1">#        if rho_W &lt; 0 * rho_W:</span>
        <span class="c1">#            print(790, &quot;negative wood density&quot;, rho_W)</span>
        <span class="c1">#            tree_status = &quot;static&quot;</span>
        <span class="c1">#            Delta_r = 0 * Delta_r</span>
        <span class="c1">#            next_r = self.r + Delta_R</span>
        <span class="c1">#</span>
        <span class="c1">#            tup = self._update_with_next_r(next_r, tree_status=tree_status)</span>
        <span class="c1">#            (</span>
        <span class="c1">#                f_L_times_E,</span>
        <span class="c1">#                f_R_times_E,</span>
        <span class="c1">#                f_T_times_E,</span>
        <span class="c1">#                f_O_times_E,</span>
        <span class="c1">#                v_T,</span>
        <span class="c1">#                v_O,</span>
        <span class="c1">#                Delta_B_TH,</span>
        <span class="c1">#                Delta_B_TS,</span>
        <span class="c1">#                rho_W,</span>
        <span class="c1">#            ) = tup</span>

        <span class="nb">print</span><span class="p">(</span><span class="mi">737</span><span class="p">,</span> <span class="n">tree_status</span><span class="p">,</span> <span class="n">tup</span><span class="p">)</span>

        <span class="n">fraction_E_required_for_status</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">f_L_times_E</span> <span class="o">+</span> <span class="n">f_R_times_E</span> <span class="o">+</span> <span class="n">f_T_times_E</span> <span class="o">+</span> <span class="n">f_O_times_E</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">E</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">742</span><span class="p">,</span> <span class="n">tree_status</span><span class="p">,</span> <span class="n">fraction_E_required_for_status</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S_star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S_star</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_S</span><span class="p">,</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="n">zeta_dw</span> <span class="o">/</span> <span class="n">zeta_gluc</span><span class="p">)</span>

        <span class="n">B_L_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_L</span>
        <span class="n">B_R_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span>
        <span class="n">B_OS_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OS</span>
        <span class="n">B_OH_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OH</span>
        <span class="n">B_TS_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span>
        <span class="n">B_TH_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span>
        <span class="n">delta_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_S</span>

        <span class="n">delta_W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_delta_W</span><span class="p">(</span><span class="n">rho_W</span><span class="p">)</span>
        <span class="n">C_S_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S_star</span>

        <span class="c1"># for recording in simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rho_W</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_W</span>  <span class="c1"># pylint: disable=attribute-defined-outside-init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delta_W</span> <span class="o">=</span> <span class="n">delta_W</span>  <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tree status:&quot;</span><span class="p">,</span> <span class="n">tree_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_status</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tree_status</span> <span class="o">==</span> <span class="s2">&quot;healthy&quot;</span><span class="p">:</span>
            <span class="n">f_CS_times_CS</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">f_O_times_E</span>

        <span class="k">if</span> <span class="n">tree_status</span> <span class="o">==</span> <span class="s2">&quot;static&quot;</span><span class="p">:</span>
            <span class="c1"># glucose flux from E to B_OS and C_S and growth respiration</span>
            <span class="c1">#            if (not root_res.success) and (fraction_E_required_for_healthy) &lt; 1.0:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">success</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fraction_E_required_for_status</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="mi">774</span><span class="p">,</span> <span class="s2">&quot;cannot use all E&quot;</span><span class="p">)</span>
                <span class="n">f_O_star_times_E</span> <span class="o">=</span> <span class="n">f_O_times_E</span>
                <span class="n">f_CS_times_CS</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">f_O_times_E</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_O_star_times_E</span> <span class="o">=</span> <span class="n">E</span> <span class="o">-</span> <span class="n">f_L_times_E</span> <span class="o">-</span> <span class="n">f_R_times_E</span>
                <span class="n">f_CS_times_CS</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_O&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_O</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_OS_old</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span>
                    <span class="s2">&quot;C_gW&quot;</span>
                <span class="p">]</span> <span class="o">-</span> <span class="n">f_O_star_times_E</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_W</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="mi">782</span><span class="p">,</span> <span class="n">f_CS_times_CS</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">f_CS_times_CS</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">f_CS_times_CS</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Flux from CS is negative, we set it to zero.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WE SHOULD NEVER BE HERE&quot;</span><span class="p">)</span>

                <span class="c1">#                f_O_star_times_E = f_O_star_times_E + f_CS_times_CS</span>

                <span class="c1"># make sure, Delta_B_OS == 0 by removing the part that would</span>
                <span class="c1"># go to C_S, adapt the different costs,</span>
                <span class="c1"># note that f_CS_times_CS is negative</span>
                <span class="n">f_O_star_times_E</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">f_CS_times_CS</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_W</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">f_CS_times_CS</span> <span class="o">*=</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="mi">797</span><span class="p">,</span> <span class="n">f_CS_times_CS</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">f_CS_times_CS</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span><span class="p">:</span>
                <span class="n">tree_status</span> <span class="o">=</span> <span class="s2">&quot;shrinking&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Changing from &#39;static&#39; to &#39;shrinking&#39;.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># update actual fluxes from E to other</span>
                <span class="n">f_O_times_E</span> <span class="o">=</span> <span class="n">f_O_star_times_E</span>

                <span class="n">Delta_B_OS_</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">f_O_times_E</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_W</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">f_CS_times_CS</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span>
                    <span class="o">-</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_O&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_O</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_OS_old</span>
                <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
                <span class="nb">print</span><span class="p">(</span><span class="mi">818</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_age</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">tree_status</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f_O_times_E</span><span class="p">,</span> <span class="n">f_CS_times_CS</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">B_OS</span><span class="p">,</span>
                    <span class="n">B_OS_old</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">B_OS</span> <span class="o">-</span> <span class="n">B_OS_old</span><span class="p">,</span>
                    <span class="n">Delta_B_OS_</span><span class="p">,</span>
                    <span class="n">f_CS_times_CS</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_OH</span><span class="p">,</span> <span class="n">B_OH_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OH</span> <span class="o">-</span> <span class="n">B_OH_old</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span><span class="p">,</span> <span class="n">B_TS_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span> <span class="o">-</span> <span class="n">B_TS_old</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span><span class="p">,</span> <span class="n">B_TH_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span> <span class="o">-</span> <span class="n">B_TH_old</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tree_status</span> <span class="o">==</span> <span class="s2">&quot;shrinking&quot;</span><span class="p">:</span>
            <span class="c1"># scale down allocation equally</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">f_L_times_E</span><span class="p">,</span> <span class="n">f_R_times_E</span><span class="p">,</span> <span class="n">f_O_times_E</span>
            <span class="n">f_L_times_E</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">E</span>
            <span class="n">f_R_times_E</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">E</span>
            <span class="n">f_O_times_E</span> <span class="o">=</span> <span class="n">z</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">E</span>

            <span class="n">f_CS_times_CS</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_O&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_O</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_OS_old</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span>
                <span class="s2">&quot;C_gW&quot;</span>
            <span class="p">]</span> <span class="o">-</span> <span class="n">f_O_times_E</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_W</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="mi">816</span><span class="p">,</span> <span class="n">f_CS_times_CS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f_CS_times_CS</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">f_CS_times_CS</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Flux from CS is negative, we set it to zero.&quot;</span><span class="p">)</span>
                <span class="n">f_CS_times_CS</span> <span class="o">*=</span> <span class="mi">0</span>

            <span class="c1"># adapt leave and root changes, store the values, they will be</span>
            <span class="c1"># needed in the properties as long as the tree is shrinking</span>
            <span class="n">Delta_B_L</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">f_L_times_E</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gL&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;delta_L&quot;</span><span class="p">])</span>
                <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_L&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_L_old</span>
            <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_B_L</span> <span class="o">=</span> <span class="n">B_L_old</span> <span class="o">+</span> <span class="n">Delta_B_L</span>

            <span class="n">Delta_B_R</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">f_R_times_E</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gR&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;delta_R&quot;</span><span class="p">])</span>
                <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_R&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_R_old</span>
            <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_B_R</span> <span class="o">=</span> <span class="n">B_R_old</span> <span class="o">+</span> <span class="n">Delta_B_R</span>

        <span class="c1">#            if f_CS_times_CS * self.Delta_t &gt; self.C_S:</span>
        <span class="c1">#                msg = (</span>
        <span class="c1">#                    &quot;While shrinking, tree has not enough reserves to &quot;</span>
        <span class="c1">#                    &quot;sustain its coarse roots and branches. Emergency!&quot;</span>
        <span class="c1">#                    &quot;&quot;</span>
        <span class="c1">#                )</span>
        <span class="c1">#                print(msg)</span>
        <span class="c1">#                raise TreeShrinkError()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tree_status</span> <span class="o">=</span> <span class="n">tree_status</span>

        <span class="c1"># update C_S, B_TH, B_TS</span>
        <span class="c1"># Eq. (1D)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_C_S</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">delta_W</span><span class="p">,</span> <span class="n">f_T_times_E</span><span class="p">,</span> <span class="n">f_O_times_E</span><span class="p">,</span> <span class="n">v_T</span><span class="p">,</span> <span class="n">v_O</span><span class="p">,</span> <span class="n">f_CS_times_CS</span><span class="p">)</span>

        <span class="c1"># check if C_S is depleted in unhealthy state</span>
        <span class="c1">#        if (self.tree_status in [&quot;static&quot;, &quot;shrinking&quot;]) and (</span>
        <span class="c1">#            self.delta_S &lt; 0.02 * zeta_dw / zeta_gluc</span>
        <span class="c1">#        ):</span>
        <span class="c1">#        if (self.tree_status in [&quot;static&quot;, &quot;shrinking&quot;]) and (</span>
        <span class="c1">#            self.C_S &lt; 0.5 * self.C_S_star</span>
        <span class="c1">#        ):</span>
        <span class="c1">#            self.delta_S &lt; 0.5 * delta_W</span>
        <span class="c1">#        ):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_status</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="s2">&quot;shrinking&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;delta_S = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_S</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="mf">0.02</span><span class="o">*</span><span class="n">zeta_dw</span><span class="o">/</span><span class="n">zeta_gluc</span><span class="si">}</span><span class="s2">, emergency&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C_S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S_star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S_star</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;951, old barrier&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_S</span><span class="p">,</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="n">zeta_dw</span> <span class="o">/</span> <span class="n">zeta_gluc</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;new_barrier&quot;</span><span class="p">,</span> <span class="n">delta_W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_S</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">delta_W</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">TreeShrinkError</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span> <span class="o">+</span> <span class="n">Delta_B_TH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span> <span class="o">+</span> <span class="n">Delta_B_TS</span>

        <span class="c1"># update remaining tree status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">next_r</span>

        <span class="c1"># increase the tree age</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_age</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>

        <span class="c1"># self._Delta_r is stored as a starting point for next year&#39;s</span>
        <span class="c1"># optimization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Delta_r</span> <span class="o">=</span> <span class="n">Delta_r</span>  <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

        <span class="c1"># clear cache to avoid using old tree data for future computations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_status</span> <span class="o">==</span> <span class="s2">&quot;healthy&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_age</span><span class="p">)</span>

        <span class="c1"># check internal consistency</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span>

        <span class="c1"># Eq. (1A)</span>
        <span class="n">Delta_B_L</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">f_L_times_E</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gL&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;delta_L&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_L&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_L_old</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_L</span> <span class="o">-</span> <span class="n">B_L_old</span> <span class="o">-</span> <span class="n">Delta_B_L</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="s2">&quot;g_dw&quot;</span><span class="p">)</span>

        <span class="c1"># Eq. (1B)</span>
        <span class="n">Delta_B_R</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">f_R_times_E</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gR&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;delta_R&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_R&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_R_old</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_R</span> <span class="o">-</span> <span class="n">B_R_old</span> <span class="o">-</span> <span class="n">Delta_B_R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="s2">&quot;g_dw&quot;</span><span class="p">)</span>

        <span class="c1"># Eq. (1E)</span>
        <span class="n">Delta_B_OS</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">f_O_times_E</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_W</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">f_CS_times_CS</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_O&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_O</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_OS_old</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
        <span class="c1">#        print(917, self.r, self.dbh, self.H, self.tree_age, self.SW, self.C_S)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_OS</span> <span class="o">-</span> <span class="n">B_OS_old</span> <span class="o">-</span> <span class="n">Delta_B_OS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="s2">&quot;g_dw&quot;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tree_status</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f_O_times_E</span><span class="p">,</span> <span class="n">f_CS_times_CS</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_OS</span><span class="p">,</span> <span class="n">B_OS_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OS</span> <span class="o">-</span> <span class="n">B_OS_old</span><span class="p">,</span> <span class="n">Delta_B_OS</span><span class="p">,</span> <span class="n">f_CS_times_CS</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_OH</span><span class="p">,</span> <span class="n">B_OH_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OH</span> <span class="o">-</span> <span class="n">B_OH_old</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span><span class="p">,</span> <span class="n">B_TS_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span> <span class="o">-</span> <span class="n">B_TS_old</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span><span class="p">,</span> <span class="n">B_TH_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span> <span class="o">-</span> <span class="n">B_TH_old</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_OS</span> <span class="o">-</span> <span class="n">B_OS_old</span> <span class="o">-</span> <span class="n">Delta_B_OS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="s2">&quot;g_dw&quot;</span><span class="p">)</span>

        <span class="c1"># Eq. (1F)</span>
        <span class="n">Delta_B_OH</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">delta_S</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gHW&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">v_O</span> <span class="o">*</span> <span class="n">B_OS_old</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_O&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_OH_old</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_OH</span> <span class="o">-</span> <span class="n">B_OH_old</span> <span class="o">-</span> <span class="n">Delta_B_OH</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="s2">&quot;g_dw&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span> <span class="o">-</span> <span class="n">B_TH_old</span> <span class="o">-</span> <span class="n">Delta_B_TH</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="s2">&quot;g_dw&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span> <span class="o">-</span> <span class="n">B_TS_old</span> <span class="o">-</span> <span class="n">Delta_B_TS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="s2">&quot;g_dw&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">f_L_times_E</span><span class="p">,</span>
            <span class="n">f_R_times_E</span><span class="p">,</span>
            <span class="n">f_O_times_E</span><span class="p">,</span>
            <span class="n">f_T_times_E</span><span class="p">,</span>
            <span class="n">v_O</span><span class="p">,</span>
            <span class="n">v_T</span><span class="p">,</span>
            <span class="n">delta_W</span><span class="p">,</span>
            <span class="n">f_CS_times_CS</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dbh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Diameter at breast height [cm].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;dbh&quot;</span><span class="p">,</span>
            <span class="n">tree_utils</span><span class="o">.</span><span class="n">dbh_from_r</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">H</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tree height [m].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">V_T</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trunk volume as computed by ACGCA [m3].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;V_T&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">V_TS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Volume of trunk sapwood [m3].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;B_TH&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;V_TH&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;V_TS&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TS_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">V_TH</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Volume of trunk heartwood section [m3].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;B_TH&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">assign</span><span class="p">(</span>
                <span class="s2">&quot;V_TH&quot;</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;V_TH&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TH_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">H_TH</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Height of trunk heartwood section [m].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;H_TH&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_TH_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">LA</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total leaf area [m2].&quot;&quot;&quot;</span>
        <span class="c1">#        return assign(&quot;LA&quot;, self.LA_func(self.dbh, self.H))</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;LA&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LA_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_L</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SLA</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Specific leaf area [m2 kg_dw-1].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLA_func</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">B_L</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Leaf biomass [g_dw].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_status</span> <span class="o">!=</span> <span class="s2">&quot;shrinking&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_L&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_L_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_L&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_L</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">B_R</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total fine root area [m2].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_status</span> <span class="o">!=</span> <span class="s2">&quot;shrinking&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_R&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_R_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_R&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_R</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">B_OS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coarse roots and branches (other) sapwood biomass [g_dw].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OS_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">B_S</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sapwood biomass (coarse roots and branches + trunk) [g_dw].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_S&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_S_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">B_T</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trunk biomass (sapwood + heartwood) [g_dw].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;B_TS&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">assign</span><span class="p">(</span>
                <span class="s2">&quot;B_T&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_T_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OS</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_T&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">B_OH</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coarse roots and branches heartwood biomass [g_dw].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_OH&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OH_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span><span class="p">))</span>

    <span class="c1"># Is computed before it enters this tree here, not part of E</span>
    <span class="c1"># Used here only for output purposes and does not take into account</span>
    <span class="c1"># corrections that are necessary to close the GlucodeBudget</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">R_M</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Maintenance respiration [g_gluc yr-1].&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;R_M&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;R_mL&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_L</span>
                <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;R_mR&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span>
                <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;R_mS&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_S_star</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">B_S_star</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Biomass of &#39;living&#39; sapwood [g_dw].&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">B_S_star_</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;B_S_star&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="p">(</span>
                    <span class="mi">1</span>
                    <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma_W&quot;</span><span class="p">]</span>
                    <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma_X&quot;</span><span class="p">])</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span>
                    <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TS</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_S</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma_C&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TS</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="n">B_S_star_</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">B_S_star_</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">C_S_star</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Max. potential amount of labile carbon storage of bulk sapwood [g_gluc].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;C_S_star&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S_star_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delta_S</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Concentration of labile carbon storage of bulk sapwood [g_gluc g_dw-1].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;delta_S&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_S</span><span class="p">)</span>

    <span class="c1">###############################################################################</span>

<div class="viewcode-block" id="SingleTree.compute_delta_W"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.compute_delta_W">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[mass_dryweight]/[volume]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_delta_W</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho_W</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Maximum labile C storage capacity of newly produced sapwood [g_gluc g_dw-1].</span>

<span class="sd">        Args:</span>
<span class="sd">            rho_W: density of newly produced sapwood [g_dw m-3]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">delta_W_</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;delta_W&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma_C&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma_X&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma_W&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_W</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">rho_W</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># don&#39;t check here, it will be negative for negative</span>
        <span class="c1"># rho_W during the process of solving the glucose budget</span>
        <span class="c1">#        assert delta_W_ &gt; 0</span>
        <span class="k">return</span> <span class="n">delta_W_</span></div>

<div class="viewcode-block" id="SingleTree.compute_rho_from_allometry"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.compute_rho_from_allometry">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_rho_from_allometry</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">V_T</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wood density as predicted by allometries [g_dw m-3].</span>

<span class="sd">        Args:</span>
<span class="sd">            dbh: diameter at breas height [cm]</span>
<span class="sd">            H: tree height [m]</span>
<span class="sd">            V_T (optional): trunk volume [m3], default: self.V_T</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mtrunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtrunk_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;g_dw&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">V_T</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">V_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mtrunk</span> <span class="o">/</span> <span class="n">V_T</span></div>

<div class="viewcode-block" id="SingleTree.compute_rho_W"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.compute_rho_W">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_rho_W</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">next_dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">next_H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Delta_r</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Density of newly produced sapwood [g_dw m-3].</span>

<span class="sd">        Args:</span>
<span class="sd">            next_dbh: dbh AFTER tree growth has taken place [cm]</span>
<span class="sd">            next_H: tree height AFTER tree growth has taken place [m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">next_V_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">,</span> <span class="n">next_H</span><span class="p">)</span>
        <span class="n">Delta_V_T</span> <span class="o">=</span> <span class="n">next_V_T</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T</span>

        <span class="n">next_mtrunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtrunk_func</span><span class="p">(</span><span class="n">next_dbh</span><span class="p">,</span> <span class="n">next_H</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;g_dw&quot;</span><span class="p">)</span>

        <span class="n">rho_Wmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;rho_Wmin&quot;</span><span class="p">]</span>
        <span class="n">rho_Wmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;rho_Wmax&quot;</span><span class="p">]</span>

        <span class="n">delta_W_unit</span> <span class="o">=</span> <span class="n">var_infos</span><span class="p">[</span><span class="s2">&quot;delta_W&quot;</span><span class="p">][</span><span class="s2">&quot;target_unit&quot;</span><span class="p">]</span>  <span class="c1"># g_gluc / g_dw</span>
        <span class="n">delta_W</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_delta_W&quot;</span><span class="p">,</span> <span class="n">Q_</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">delta_W_unit</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">Delta_V_T</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">Delta_V_T</span><span class="p">:</span>
            <span class="n">correction_for_C_ST</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_W_unit</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta_W</span>
            <span class="c1"># keep the followinf line for the wrong version in the manuscript</span>
            <span class="c1"># TODO: change the manuscript, remove the line, run everything again</span>
            <span class="c1">#            correction_for_C_ST = Q_(1, delta_W_unit)</span>

            <span class="n">unit_correction</span> <span class="o">=</span> <span class="n">zeta_dw</span> <span class="o">/</span> <span class="n">zeta_gluc</span>
            <span class="n">rho_W</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_mtrunk</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_T</span><span class="p">)</span> <span class="o">/</span> <span class="n">Delta_V_T</span> <span class="o">/</span> <span class="n">correction_for_C_ST</span>
            <span class="n">rho_W</span> <span class="o">*=</span> <span class="n">unit_correction</span>  <span class="c1"># make it to g_dw / m^3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rho_W</span> <span class="o">=</span> <span class="n">rho_Wmax</span>

        <span class="n">rho_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">rho_W</span><span class="p">,</span> <span class="n">rho_Wmax</span><span class="p">)</span>
        <span class="n">rho_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">rho_W</span><span class="p">,</span> <span class="n">rho_Wmin</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;rho_W&quot;</span><span class="p">,</span> <span class="n">rho_W</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.compute_f_L_times_E"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.compute_f_L_times_E">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_f_L_times_E</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_B_L</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flux from transient pool to leaves [g_gluc yr-1].</span>

<span class="sd">        Args:</span>
<span class="sd">            next_B_L: leaf biomass of tree AFTER growth has taken place [g_dw]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">Delta_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
        <span class="n">Delta_B_L</span> <span class="o">=</span> <span class="n">next_B_L</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_L</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;f_L_times_E&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="n">Delta_B_L</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_L&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_L</span> <span class="o">*</span> <span class="n">Delta_t</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gL&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;delta_L&quot;</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">Delta_t</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="SingleTree.compute_f_R_times_E"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.compute_f_R_times_E">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_f_R_times_E</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_B_R</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flux from transient pool to fine roots [g_gluc yr-1].</span>

<span class="sd">        Args:</span>
<span class="sd">            next_B_R: fine root biomass AFTER growth [g_dw]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">Delta_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
        <span class="n">Delta_B_R</span> <span class="o">=</span> <span class="n">next_B_R</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span>

        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;f_R_times_E&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="n">Delta_B_R</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_R&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span> <span class="o">*</span> <span class="n">Delta_t</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gR&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;delta_R&quot;</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">Delta_t</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.compute_v_T"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.compute_v_T">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[volume]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_v_T</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_V_TH</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sapwood to heartwood conversion rate of trunk [yr-1].</span>

<span class="sd">        Args:</span>
<span class="sd">            next_V_TH: trunk volume AFTER growth [m3]</span>

<span class="sd">        Returns:</span>
<span class="sd">            ``v_T``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Delta_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
        <span class="n">Delta_V_TH</span> <span class="o">=</span> <span class="n">next_V_TH</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TH</span>

        <span class="n">v_T</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;v_T&quot;</span><span class="p">,</span> <span class="n">Delta_V_TH</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TS</span> <span class="o">/</span> <span class="n">Delta_t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v_T</span></div>

<div class="viewcode-block" id="SingleTree.compute_f_T_times_E"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.compute_f_T_times_E">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;1/[time]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[volume]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[mass_dryweight]/[volume]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[mass_glucose]/[mass_dryweight]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_f_T_times_E</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">v_T</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">next_V_T</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">rho_W</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">delta_W</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flux from labile pool to trunk [g_gluc yr-1].</span>

<span class="sd">        Args:</span>
<span class="sd">            v_T: sapwood to heartwood conversion rate of trunk [yr-1]</span>
<span class="sd">            next_V_T: trunk volume AFTER growth [m3]</span>
<span class="sd">            rho_W: density of newly produced sapwood [g_dw m-3]</span>
<span class="sd">            delta_W: maximum labile C storage capacity of newly</span>
<span class="sd">                produced sapwood [g_gluc g_dw-1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Delta_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
        <span class="n">Delta_V_T</span> <span class="o">=</span> <span class="n">next_V_T</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T</span>

        <span class="n">B_TS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span>

        <span class="c1"># delta_S(t) looks like it should come from &#39;next_tree&#39;, but</span>
        <span class="c1"># the definition of delta_S (Ogle and Pacala, SD) shows otherwise</span>
        <span class="c1"># this is inconsistent with the rest of their notation</span>
        <span class="n">delta_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_S</span>

        <span class="n">f_T_times_E_</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;f_T_times_E&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">rho_W</span>
                    <span class="o">*</span> <span class="n">Delta_V_T</span>
                    <span class="c1">#                    - delta_S / self.params[&quot;C_gHW&quot;] * v_T * B_TS * Delta_t</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_W</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">Delta_t</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># the ACGCA formula allows this to become negative if there is sapwood to</span>
        <span class="c1"># heartwood conversion but (almost) no trunk volume growth</span>
        <span class="c1"># adapted formula, so this here should be superfluous</span>
        <span class="k">if</span> <span class="n">f_T_times_E_</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">f_T_times_E_</span><span class="p">:</span>
            <span class="n">f_T_times_E_</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">f_T_times_E_</span>

        <span class="k">return</span> <span class="n">f_T_times_E_</span></div>

<div class="viewcode-block" id="SingleTree.compute_f_O_times_E"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.compute_f_O_times_E">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;1/[time]&quot;</span><span class="p">,</span> <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">,</span> <span class="s2">&quot;[mass_glucose]/[mass_dryweight]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_f_O_times_E</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">v_O</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">next_B_OS</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">delta_W</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flux from labile pool to coarse roots and branches [g_gluc yr-1].</span>

<span class="sd">        Args:</span>
<span class="sd">            v_O: sapwood to heartwood conversion rate of other [yr-1]</span>
<span class="sd">            next_B_OS: other sapwood biomass AFTER growth [g_dw]</span>
<span class="sd">            delta_W: maximum labile C storage capacity of newly</span>
<span class="sd">                produced sapwood [g_gluc g_dw-1]</span>
<span class="sd">            next_tree (same class): Tree with allometries AFTER solving</span>
<span class="sd">                the carbon budget for ``Delta_r``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">B_OS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OS</span>
        <span class="n">Delta_B_OS</span> <span class="o">=</span> <span class="n">next_B_OS</span> <span class="o">-</span> <span class="n">B_OS</span>
        <span class="n">Delta_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>

        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;f_O_times_E&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">Delta_B_OS</span> <span class="o">+</span> <span class="n">Delta_t</span> <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_O&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_O</span><span class="p">)</span> <span class="o">*</span> <span class="n">B_OS</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">Delta_t</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_W</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.update_C_S"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.update_C_S">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;[mass_glucose]/[time]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[mass_glucose]/[mass_dryweight]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[mass_glucose]/[time]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[mass_glucose]/[time]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;1/[time]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;1/[time]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[mass_glucose]/[time]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_C_S</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">E</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">delta_W</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">f_T_times_E</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">f_O_times_E</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">v_T</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">v_O</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">f_CS_times_CS</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update C_S after carbon budget is solved for ``Delta_r``.</span>

<span class="sd">        Args:</span>
<span class="sd">            Anet_gluc: incoming net radiaton [g_gluc yr-1]</span>
<span class="sd">            delta_W: maximum labile C storage capacity of newly</span>
<span class="sd">                produced sapwood [g_gluc g_dw-1]</span>
<span class="sd">            f_T_times_E: flux from labile pool to trunk [g_gluc yr-1]</span>
<span class="sd">            f_O_times_E: flux from labile pool to other [g_gluc yr-1]</span>
<span class="sd">            v_T: sapwood to heartwood conversion rate of trunk [yr-1]</span>
<span class="sd">            v_O: sapwood to heartwood conversion rate of other [yr-1]</span>
<span class="sd">            f_CS_times_CS: in &quot;static&quot; state amount of glucose to use from reserves</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">Delta_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>

        <span class="n">B_OS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OS</span>
        <span class="n">B_TS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span>

        <span class="n">f_T</span> <span class="o">=</span> <span class="n">f_T_times_E</span> <span class="o">/</span> <span class="n">E</span>
        <span class="n">f_O</span> <span class="o">=</span> <span class="n">f_O_times_E</span> <span class="o">/</span> <span class="n">E</span>

        <span class="n">delta_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_S</span>

        <span class="n">Delta_C_S_positive_part</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">E</span> <span class="o">*</span> <span class="n">delta_W</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_W</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_T</span> <span class="o">+</span> <span class="n">f_O</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">Delta_t</span>
        <span class="c1">#        print(1347, Delta_C_S_positive_part)</span>
        <span class="n">Delta_C_S_negative_part_without_B_OS</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">+</span><span class="n">zeta_dw</span> <span class="o">/</span> <span class="n">zeta_gluc</span> <span class="o">*</span> <span class="n">delta_S</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gHW&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v_O</span> <span class="o">*</span> <span class="n">B_OS</span> <span class="o">*</span> <span class="n">Delta_t</span>
            <span class="o">+</span> <span class="n">delta_S</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_O&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_OS</span> <span class="o">*</span> <span class="n">Delta_t</span>
            <span class="o">+</span> <span class="n">zeta_dw</span> <span class="o">/</span> <span class="n">zeta_gluc</span> <span class="o">*</span> <span class="n">delta_S</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gHW&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v_T</span> <span class="o">*</span> <span class="n">B_TS</span> <span class="o">*</span> <span class="n">Delta_t</span>
        <span class="p">)</span>
        <span class="n">Delta_C_S_negative_part_B_OS</span> <span class="o">=</span> <span class="o">+</span><span class="n">f_CS_times_CS</span> <span class="o">*</span> <span class="n">Delta_t</span>
        <span class="n">Delta_C_S_negative_part</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Delta_C_S_negative_part_without_B_OS</span> <span class="o">+</span> <span class="n">Delta_C_S_negative_part_B_OS</span>
        <span class="p">)</span>
        <span class="c1">#        print(1357, Delta_C_S_negative_part)</span>

        <span class="c1"># check if more C_S is trying to be used than is actually available</span>
        <span class="c1"># BEFORE new glucose comes in from the transient pool E</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">-</span> <span class="n">Delta_C_S_negative_part</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="c1"># Too much C_S is being tried to use.</span>

            <span class="c1"># if this fails, then something is seriously wrong</span>
            <span class="nb">print</span><span class="p">(</span><span class="mi">1469</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span><span class="p">,</span> <span class="n">Delta_C_S_negative_part_without_B_OS</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f_T</span><span class="p">,</span> <span class="n">f_O</span><span class="p">,</span> <span class="n">v_T</span><span class="p">,</span> <span class="n">v_O</span><span class="p">,</span> <span class="n">B_TS</span><span class="p">,</span> <span class="n">B_OS</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">-</span> <span class="n">Delta_C_S_negative_part_without_B_OS</span> <span class="o">&gt;=</span> <span class="mi">0</span>

            <span class="c1"># if we end up here, then we need too much C_S for regrowth of &quot;other&quot;</span>
            <span class="c1"># we call emergency</span>
            <span class="k">raise</span> <span class="n">TreeShrinkError</span><span class="p">()</span>

        <span class="n">Delta_C_S</span> <span class="o">=</span> <span class="n">Delta_C_S_positive_part</span> <span class="o">-</span> <span class="n">Delta_C_S_negative_part</span>

        <span class="c1"># store it to use it as an approximation of the new value</span>
        <span class="c1"># in computation of rho_W</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Delta_C_S</span> <span class="o">=</span> <span class="n">Delta_C_S</span>  <span class="c1"># pylint: disable=attribute-defined-outside-init</span>
        <span class="c1">#        print(1378, self.C_S, Delta_C_S)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;C_S&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">+</span> <span class="n">Delta_C_S</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_S</span> <span class="o">&gt;=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="SingleTree.compute_v_O"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.compute_v_O">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_v_O</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_B_OH</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sapwood to heartwood conversion rate of coarse roots and branches [yr-1].</span>

<span class="sd">        Args:</span>
<span class="sd">            next_B_OH: other heartwood biomass AFTER growth [g_dw]</span>

<span class="sd">        Returns:</span>
<span class="sd">            ``v_O``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">B_OH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OH</span>
        <span class="n">B_OS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OS</span>
        <span class="n">Delta_B_OH</span> <span class="o">=</span> <span class="n">next_B_OH</span> <span class="o">-</span> <span class="n">B_OH</span>
        <span class="n">Delta_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Delta_t</span>
        <span class="n">v_O</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;v_O&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">Delta_B_OH</span> <span class="o">+</span> <span class="n">Delta_t</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;S_O&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_OH</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">Delta_t</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_S</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;C_gHW&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">B_OS</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">v_O</span></div>

<div class="viewcode-block" id="SingleTree.SLA_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.SLA_func">[docs]</a>    <span class="k">def</span> <span class="nf">SLA_func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Specific leaf area [m2 kg_dw-1].&quot;&quot;&quot;</span>
        <span class="n">SLA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;SLA&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">SLA</span></div>

<div class="viewcode-block" id="SingleTree.B_L_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.B_L_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">B_L_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Leaf biomass [g_dw].&quot;&quot;&quot;</span>

        <span class="n">dbh_cm</span> <span class="o">=</span> <span class="n">dbh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">H_m</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;leaves&quot;</span><span class="p">]</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">allometries</span><span class="p">(</span><span class="n">dbh_cm</span><span class="p">,</span> <span class="n">H_m</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span><span class="p">),</span>
            <span class="s2">&quot;kg_dw&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;g_dw&quot;</span><span class="p">)</span>

        <span class="n">B_L_g_dw</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;delta_L&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">zeta_gluc</span> <span class="o">/</span> <span class="n">zeta_dw</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_L&quot;</span><span class="p">,</span> <span class="n">B_L_g_dw</span><span class="p">)</span>  <span class="c1"># g_dw</span></div>

<div class="viewcode-block" id="SingleTree.mtrunk_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.mtrunk_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">mtrunk_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trunk biomass from external allometries [g_dw].&quot;&quot;&quot;</span>
        <span class="n">dbh_cm</span> <span class="o">=</span> <span class="n">dbh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">H_m</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stemwood&quot;</span><span class="p">,</span> <span class="s2">&quot;stembark&quot;</span><span class="p">,</span> <span class="s2">&quot;stump&quot;</span><span class="p">]</span>
        <span class="n">mtrunk</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">allometries</span><span class="p">(</span>
                <span class="n">dbh_cm</span><span class="p">,</span> <span class="n">H_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span>
            <span class="p">),</span>
            <span class="s2">&quot;kg_dw&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">mtrunk</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;g_dw&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.mother_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.mother_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">mother_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Biomass of coarse roots and branches from external allometries [g_dw].&quot;&quot;&quot;</span>
        <span class="n">dbh_cm</span> <span class="o">=</span> <span class="n">dbh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">H_m</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;livingbranches&quot;</span><span class="p">,</span> <span class="s2">&quot;roots&quot;</span><span class="p">]</span>
        <span class="n">mother</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">allometries</span><span class="p">(</span>
                <span class="n">dbh_cm</span><span class="p">,</span> <span class="n">H_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span>
            <span class="p">),</span>
            <span class="s2">&quot;kg_dw&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">mother</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;g_dw&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.mstump_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.mstump_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">mstump_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stump biomass from external allometries [g_dw].&quot;&quot;&quot;</span>
        <span class="n">dbh_cm</span> <span class="o">=</span> <span class="n">dbh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">H_m</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stump&quot;</span><span class="p">]</span>
        <span class="n">mstump</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">allometries</span><span class="p">(</span>
                <span class="n">dbh_cm</span><span class="p">,</span> <span class="n">H_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span>
            <span class="p">),</span>
            <span class="s2">&quot;kg_dw&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">mstump</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;g_dw&quot;</span><span class="p">)</span></div>

    <span class="c1">#    @ureg.check(None, &quot;[length]&quot;, &quot;[length]&quot;)</span>
    <span class="c1">#    def LA_func(self, dbh: Q_[float], H: Q_[float]) -&gt; Q_[float]:</span>
<div class="viewcode-block" id="SingleTree.LA_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.LA_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">LA_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_L</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total leaf area [m2].&quot;&quot;&quot;</span>
        <span class="n">SLA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLA_func</span><span class="p">()</span>
        <span class="c1">#        B_L = self.B_L_func(dbh, H)</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;LA&quot;</span><span class="p">,</span> <span class="n">SLA</span> <span class="o">*</span> <span class="n">B_L</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.B_R_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.B_R_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">B_R_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fine root biomass [g_dw].&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">B_L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_L_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_R&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rho_RL&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_L</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.lambda_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.lambda_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lambda_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ratio of other (branches + coarse roots) to trunk.</span>

<span class="sd">        This ratio comes from external allometries based on</span>
<span class="sd">        given diameter at breast height ``dbh`` and tree height ``H``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mother</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mother_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;g_dw&quot;</span><span class="p">)</span>
        <span class="n">mtrunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtrunk_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;g_dw&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mother</span> <span class="o">/</span> <span class="n">mtrunk</span></div>

<div class="viewcode-block" id="SingleTree.lambda_H_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.lambda_H_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lambda_H_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ratio of other heartwood to trunk heartwood by external allometries.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.lambda_S_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.lambda_S_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lambda_S_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ratio of other sapwood to trunk sapwood by external allometries.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.B_OS_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.B_OS_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">B_OS_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">B_TS</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coarse roots and branches (other) sapwood biomass [g_dw].&quot;&quot;&quot;</span>
        <span class="n">lambda_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_S_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_OS&quot;</span><span class="p">,</span> <span class="n">lambda_S</span> <span class="o">*</span> <span class="n">B_TS</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.B_S_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.B_S_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">B_S_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">B_TS</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sapwood biomass (coarse roots and branches + trunk) [g_dw].&quot;&quot;&quot;</span>
        <span class="n">B_OS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_OS_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">B_TS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_S&quot;</span><span class="p">,</span> <span class="n">B_TS</span> <span class="o">+</span> <span class="n">B_OS</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.B_OH_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.B_OH_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">B_OH_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">B_TH</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coarse roots and branches (other) heartwood biomass [g_dw].&quot;&quot;&quot;</span>
        <span class="n">lambda_H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_H_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_OH&quot;</span><span class="p">,</span> <span class="n">lambda_H</span> <span class="o">*</span> <span class="n">B_TH</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.B_T_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.B_T_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[mass_glucose]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">B_T_func</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">B_TS</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">B_TH</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">C_S</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">B_OS</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trunk biomass [g_dw].</span>

<span class="sd">        ``B_T = B_TS + B_TH`` plus ``C_S`` associated to trunk sapwood.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;B_T&quot;</span><span class="p">,</span> <span class="n">B_TS</span> <span class="o">+</span> <span class="n">B_TH</span> <span class="o">+</span> <span class="n">B_TS</span> <span class="o">/</span> <span class="p">(</span><span class="n">B_TS</span> <span class="o">+</span> <span class="n">B_OS</span><span class="p">)</span> <span class="o">*</span> <span class="n">C_S</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">B_TS</span><span class="o">.</span><span class="n">units</span><span class="p">))</span></div>

<div class="viewcode-block" id="SingleTree.H_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.H_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">H_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tree height from diameter at breast height [m].</span>

<span class="sd">        Based on Nslund equation parameterized using Hyytil stand inventory</span>
<span class="sd">        from 2008.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">H_func</span><span class="p">(</span><span class="n">dbh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">))</span></div>

<div class="viewcode-block" id="SingleTree.h_B_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.h_B_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">h_B_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Height at which trunk transitions from a neiloid to a paraboloid [m].</span>

<span class="sd">        Args:</span>
<span class="sd">            H: tree height [m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eta_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;eta_B&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;h_B&quot;</span><span class="p">,</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">h_B_func</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">eta_B</span><span class="o">.</span><span class="n">magnitude</span><span class="p">))</span></div>

<div class="viewcode-block" id="SingleTree.h_C_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.h_C_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">h_C_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Height at which trunk transitions from a paraboloid to a cone [m].</span>

<span class="sd">        Args:</span>
<span class="sd">            H: tree height [m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eta_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;eta_C&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;h_C&quot;</span><span class="p">,</span> <span class="n">tree_utils</span><span class="o">.</span><span class="n">h_C_func</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">eta_C</span><span class="o">.</span><span class="n">magnitude</span><span class="p">))</span></div>

<div class="viewcode-block" id="SingleTree.r_B_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.r_B_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">r_B_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Radius at which trunk transitions from a neiloid to a paraboloid [m].</span>

<span class="sd">        Args:</span>
<span class="sd">            r: tree radois at trunk base [m]</span>
<span class="sd">            H: tree height [m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eta_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;eta_B&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;r_B&quot;</span><span class="p">,</span>
            <span class="n">tree_utils</span><span class="o">.</span><span class="n">r_B_func</span><span class="p">(</span>
                <span class="n">r</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">eta_B</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.r_C_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.r_C_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">r_C_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Radius at which trunk transitions from a paraboloid to a cone [m].</span>

<span class="sd">        Args:</span>
<span class="sd">            r: tree radois at trunk base [m]</span>
<span class="sd">            H: tree height [m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eta_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;eta_B&quot;</span><span class="p">]</span>
        <span class="n">eta_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;eta_C&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;r_C&quot;</span><span class="p">,</span>
            <span class="n">tree_utils</span><span class="o">.</span><span class="n">r_C_func</span><span class="p">(</span>
                <span class="n">r</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="n">eta_B</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="n">eta_C</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.V_T_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.V_T_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">V_T_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trunk volume as computed by ACGCA [m3].&quot;&quot;&quot;</span>
        <span class="n">dbh</span> <span class="o">=</span> <span class="n">dbh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="n">custom_species_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span>
        <span class="c1">#        V_T = Q_(tree_utils.V_T_func(dbh, species, custom_species_params), &quot;m^3&quot;)</span>

        <span class="n">V_T</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tree_utils</span><span class="o">.</span><span class="n">V_T_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">custom_species_params</span><span class="p">),</span> <span class="s2">&quot;m^3&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;V_T&quot;</span><span class="p">,</span> <span class="n">V_T</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.H_TH_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.H_TH_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">H_TH_func</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">SW</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>  <span class="c1"># = None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Height of trunk heartwood section [m].&quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="n">H_TH</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">tree_utils</span><span class="o">.</span><span class="n">H_TH_func</span><span class="p">(</span>
                <span class="n">SW</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span>
            <span class="p">),</span>
            <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;H_TH&quot;</span><span class="p">,</span> <span class="n">H_TH</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.V_TH_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.V_TH_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">V_TH_func</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">SW</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>  <span class="c1"># = None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Volume of trunk heartwood section [m3].&quot;&quot;&quot;</span>
        <span class="n">dbh</span> <span class="o">=</span> <span class="n">dbh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="n">V_TH</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">tree_utils</span><span class="o">.</span><span class="n">V_TH_func</span><span class="p">(</span>
                <span class="n">SW</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span>
            <span class="p">),</span>
            <span class="s2">&quot;m^3&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;V_TH&quot;</span><span class="p">,</span> <span class="n">V_TH</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.V_TS_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.V_TS_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">V_TS_func</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">SW</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Volume of trunk sapwood [m3].&quot;&quot;&quot;</span>
        <span class="n">V_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
        <span class="n">V_TH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TH_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">SW</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;V_TS&quot;</span><span class="p">,</span> <span class="n">V_T</span> <span class="o">-</span> <span class="n">V_TH</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.C_S_star_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.C_S_star_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[mass_dryweight]&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">C_S_star_func</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dbh</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">H</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">B_TS</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">SW</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Max. potential amount of labile carbon storage of bulk sapwood [g_gluc].&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">V_TS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TS_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">SW</span><span class="p">)</span>
        <span class="n">B_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_S_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">B_TS</span><span class="p">)</span>
        <span class="n">C_S_star_</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma_C&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma_X&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">V_TS</span> <span class="o">/</span> <span class="n">B_TS</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma_W&quot;</span><span class="p">])</span>
            <span class="o">*</span> <span class="n">B_S</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">C_S_star_</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;C_S_star&quot;</span><span class="p">,</span> <span class="n">C_S_star_</span><span class="p">)</span></div>

<div class="viewcode-block" id="SingleTree.SW_func"><a class="viewcode-back" href="../../../BFMM.trees.single_tree_allocation.SingleTree.html#BFMM.trees.single_tree_allocation.SingleTree.SW_func">[docs]</a>    <span class="nd">@ureg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;[length]&quot;</span><span class="p">,</span> <span class="s2">&quot;[time]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">SW_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">tree_age</span><span class="p">:</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sapwood radius at trunk base [m].</span>

<span class="sd">        Args:</span>
<span class="sd">            r: radius at trunk base [m]</span>
<span class="sd">            tree_age: age of the tree [yr]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbh</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span>
            <span class="s2">&quot;dbh&quot;</span><span class="p">,</span>
            <span class="n">tree_utils</span><span class="o">.</span><span class="n">dbh_from_r</span><span class="p">(</span>
                <span class="n">r</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;B_TS&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;C_S&quot;</span><span class="p">):</span>
            <span class="n">B_TS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TS</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;kg_dw&quot;</span><span class="p">)</span>
            <span class="n">V_TS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TS</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m^3&quot;</span><span class="p">)</span>
            <span class="n">B_TH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_TH</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;kg_dw&quot;</span><span class="p">)</span>
            <span class="n">V_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m^3&quot;</span><span class="p">)</span>

            <span class="n">rho_TS</span> <span class="o">=</span> <span class="n">B_TS</span> <span class="o">/</span> <span class="n">V_TS</span>
            <span class="n">rho_T</span> <span class="o">=</span> <span class="p">(</span><span class="n">B_TS</span> <span class="o">+</span> <span class="n">B_TH</span><span class="p">)</span> <span class="o">/</span> <span class="n">V_T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># at tree init: the value is not important,</span>
            <span class="c1"># it just needs to be the same and then cancels out</span>
            <span class="n">rho_TS</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;kg_dw/m^3&quot;</span><span class="p">)</span>
            <span class="n">rho_T</span> <span class="o">=</span> <span class="n">rho_TS</span>

        <span class="n">SW</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">tree_utils</span><span class="o">.</span><span class="n">solve_for_SW</span><span class="p">(</span>
                <span class="n">r</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="n">dbh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="n">H</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="c1">#                self.tree_age.to(&quot;yr&quot;).magnitude,</span>
                <span class="n">tree_age</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;yr&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="n">rho_TS</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="n">rho_T</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">custom_species_params</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">SW</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Q_</span><span class="p">(</span><span class="mf">1e-03</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">):</span>
            <span class="n">SW</span> <span class="o">=</span> <span class="n">r</span>

        <span class="c1"># (trunk) heartwood cannot grow back</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TH_func</span><span class="p">(</span><span class="n">dbh</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">SW</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_TH</span><span class="p">:</span>
                <span class="n">SW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;SW&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_TH_func</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">SW</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_TH</span><span class="p">:</span>
                    <span class="n">SW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SW</span>

        <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="s2">&quot;SW&quot;</span><span class="p">,</span> <span class="n">r</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">SW</span> <span class="k">else</span> <span class="n">SW</span><span class="p">)</span></div></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Holger Metzler, Samuli Launiainen, Giulia Vico
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/scripts/furo.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>