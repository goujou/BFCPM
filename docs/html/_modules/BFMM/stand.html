<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.0.1 and Furo 2023.05.20 -->
        <title>BFMM.stand - BFMM</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=e6660623a769aa55fea372102b9bf3151b292993" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">BFMM</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">BFMM</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../BFMM.prepare_stand.html">prepare_stand</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../BFMM.stand.html">stand</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of stand</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../BFMM.stand.Stand.html">Stand</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../BFMM.type_aliases.html">type_aliases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../BFMM.utils.html">utils</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../BFMM.productivity.html">productivity</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../BFMM.trees.html">trees</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of trees</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../BFMM.trees.allometry.html">allometry</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../BFMM.trees.mean_tree.html">mean_tree</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of mean_tree</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.trees.mean_tree.MeanTree.html">MeanTree</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../BFMM.trees.single_tree_C_model.html">single_tree_C_model</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of single_tree_C_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.trees.single_tree_C_model.SingleTreeCModel.html">SingleTreeCModel</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../BFMM.trees.single_tree_allocation.html">single_tree_allocation</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of single_tree_allocation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.trees.single_tree_allocation.SingleTree.html">SingleTree</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../BFMM.trees.single_tree_params.html">single_tree_params</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../BFMM.trees.single_tree_vars.html">single_tree_vars</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../BFMM.trees.tree_utils.html">tree_utils</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../BFMM.soil.html">soil</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of soil</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../BFMM.soil.dead_wood_classes.html">dead_wood_classes</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of dead_wood_classes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../BFMM.soil.dead_wood_classes.C_model.html">C_model</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of C_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../BFMM.soil.dead_wood_classes.C_model.SoilCDeadWoodClasses.html">SoilCDeadWoodClasses</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.soil.dead_wood_classes.C_model_parameters.html">C_model_parameters</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../BFMM.soil.simple_soil_model.html">simple_soil_model</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of simple_soil_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../BFMM.soil.simple_soil_model.C_model.html">C_model</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of C_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../BFMM.soil.simple_soil_model.C_model.SimpleSoilCModel.html">SimpleSoilCModel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.soil.simple_soil_model.C_model_parameters.html">C_model_parameters</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../BFMM.soil.soil_c_model_abc.html">soil_c_model_abc</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of soil_c_model_abc</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.soil.soil_c_model_abc.SoilCModelABC.html">SoilCModelABC</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../BFMM.wood_products.html">wood_products</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of wood_products</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../BFMM.wood_products.simple_wood_product_model.html">simple_wood_product_model</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of simple_wood_product_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../BFMM.wood_products.simple_wood_product_model.C_model.html">C_model</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of C_model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../BFMM.wood_products.simple_wood_product_model.C_model.SimpleWoodProductModel.html">SimpleWoodProductModel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.wood_products.simple_wood_product_model.C_model_parameters.html">C_model_parameters</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../BFMM.wood_products.wood_product_model_abc.html">wood_product_model_abc</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of wood_product_model_abc</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.wood_products.wood_product_model_abc.WoodProductModelABC.html">WoodProductModelABC</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../BFMM.management.html">management</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of management</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../BFMM.management.library.html">library</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../BFMM.management.management_strategy.html">management_strategy</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of management_strategy</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.Cut.html">Cut</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.CutAndReplant.html">CutAndReplant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.CutWaitAndReplant.html">CutWaitAndReplant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.ManagementActionABC.html">ManagementActionABC</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.ManagementStrategy.html">ManagementStrategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.OnDBHLimit.html">OnDBHLimit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.OnDTHLimit.html">OnDTHLimit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.OnDelayOneTime.html">OnDelayOneTime</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.OnNLimit.html">OnNLimit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.OnPeriodically.html">OnPeriodically</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.OnSBALimit.html">OnSBALimit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.OnSBAvsDTH.html">OnSBAvsDTH</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.OnStandAges.html">OnStandAges</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.OnTimeIntervals.html">OnTimeIntervals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.PCT.html">PCT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.Plant.html">Plant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.Thin.html">Thin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.ThinStand.html">ThinStand</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.TriggerABC.html">TriggerABC</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.management.management_strategy.WaitAndPlant.html">WaitAndPlant</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../BFMM.simulation.html">simulation</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of simulation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../BFMM.simulation.library.html">library</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../BFMM.simulation.recorded_simulation.html">recorded_simulation</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of recorded_simulation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.simulation.recorded_simulation.RecordedSimulation.html">RecordedSimulation</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../BFMM.simulation.simulation.html">simulation</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of simulation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../BFMM.simulation.simulation.Simulation.html">Simulation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../BFMM.simulation.utils.html">utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../BFMM.simulation_parameters.html">simulation_parameters</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Untitled.html">Test notebook</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for BFMM.stand</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains the :class:`~stand.Stand` class, the central part of the model.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">bgc_md2.notebook_helpers</span> <span class="kn">import</span> <span class="n">write_to_logfile</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Q_</span>
<span class="kn">from</span> <span class="nn">.management.management_strategy</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Cut</span><span class="p">,</span> <span class="n">CutWaitAndReplant</span><span class="p">,</span>
                                             <span class="n">ManagementStrategy</span><span class="p">,</span> <span class="n">OnStandAges</span><span class="p">,</span>
                                             <span class="n">Thin</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.prepare_stand</span> <span class="kn">import</span> <span class="p">(</span><span class="n">load_tree_soil_interface</span><span class="p">,</span>
                            <span class="n">load_wood_product_interface</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.productivity.constants</span> <span class="kn">import</span> <span class="p">(</span><span class="n">EPS</span><span class="p">,</span> <span class="n">MOLAR_MASS_H2O</span><span class="p">,</span> <span class="n">PAR_TO_UMOL</span><span class="p">,</span>
                                     <span class="n">micromolCO2_TO_gC</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.productivity.radiation</span> <span class="kn">import</span> <span class="n">canopy_sw_Spitters</span> <span class="k">as</span> <span class="n">sw_model_Spitters</span>
<span class="kn">from</span> <span class="nn">.productivity.radiation</span> <span class="kn">import</span> <span class="n">canopy_sw_ZhaoQualls</span> <span class="k">as</span> <span class="n">sw_model_Zhao</span>
<span class="kn">from</span> <span class="nn">.productivity.waterbalance</span> <span class="kn">import</span> <span class="n">Bucket</span><span class="p">,</span> <span class="n">Canopywaterbudget</span>
<span class="kn">from</span> <span class="nn">.soil.soil_c_model_abc</span> <span class="kn">import</span> <span class="n">SoilCModelABC</span>
<span class="kn">from</span> <span class="nn">.trees.mean_tree</span> <span class="kn">import</span> <span class="n">MeanTree</span>
<span class="kn">from</span> <span class="nn">.trees.single_tree_allocation</span> <span class="kn">import</span> <span class="n">SingleTree</span><span class="p">,</span> <span class="n">TreeShrinkError</span>
<span class="kn">from</span> <span class="nn">.trees.single_tree_C_model</span> <span class="kn">import</span> <span class="n">SingleTreeCModel</span>
<span class="kn">from</span> <span class="nn">.type_aliases</span> <span class="kn">import</span> <span class="p">(</span><span class="n">CuttingFluxes</span><span class="p">,</span> <span class="n">SpeciesParams</span><span class="p">,</span> <span class="n">SpeciesSettings</span><span class="p">,</span>
                           <span class="n">TreeExternalOutputFluxes</span><span class="p">,</span> <span class="n">TreeSoilInterface</span><span class="p">,</span>
                           <span class="n">WoodProductInterface</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">assert_accuracy</span><span class="p">,</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">.wood_products.wood_product_model_abc</span> <span class="kn">import</span> <span class="n">WoodProductModelABC</span>


<div class="viewcode-block" id="Stand"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand">[docs]</a><span class="k">class</span> <span class="nc">Stand</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A stand is a compilation of trees, a soil model and a wood product model.</span>

<span class="sd">    It is used as basis to model microclimatic regimes (light, wind),</span>
<span class="sd">    canopy and soil water budget and call tree A-gs computations.</span>
<span class="sd">    Trees return their external output fluxes to the stand who in turn</span>
<span class="sd">    forwards soil inputs to the soil model.</span>

<span class="sd">    The productivity part of the stand runs of half-hourly basis,</span>
<span class="sd">    whereas the trees and the soil models are updated annualy.</span>

<span class="sd">    Args:</span>
<span class="sd">        z: grid of tree height layer boundaries [m]</span>
<span class="sd">        loc: location dictionary</span>

<span class="sd">            - &quot;lat&quot;, &quot;lon&quot;: latitude and longitude [deg]</span>

<span class="sd">        ctr: control dictionary</span>

<span class="sd">            - &quot;phenology&quot;: include phenology?</span>
<span class="sd">            - &quot;leaf_area&quot;: &quot;seasonal LAI cycle?</span>
<span class="sd">            - &quot;water_stress&quot;: include water stress?</span>

<span class="sd">        water_p: water_p dictionary</span>

<span class="sd">            - &quot;interception&quot;:</span>
<span class="sd">                - &quot;LAI&quot;: ??? [???]</span>
<span class="sd">                - &quot;wmax&quot;: ??? [???]</span>
<span class="sd">                - &quot;alpha&quot;: ??? [???]</span>
<span class="sd">            - &quot;snowpack&quot;:</span>
<span class="sd">                - &quot;Tm&quot;: ??? [???]</span>
<span class="sd">                - &quot;Km&quot;: ??? [???]</span>
<span class="sd">                - &quot;Kf&quot;: ??? [???]</span>
<span class="sd">                - &quot;R&quot;: ??? [???]</span>
<span class="sd">                - &quot;Tmax&quot;: ??? [???]</span>
<span class="sd">                - &quot;Tmin&quot;: ??? [???]</span>
<span class="sd">                - &quot;sliq&quot;: ??? [???]</span>
<span class="sd">                - &quot;Sice&quot;: ??? [???]</span>
<span class="sd">            - &quot;organic:layer&quot;:</span>
<span class="sd">                - &quot;DM&quot;: ??? [???]</span>
<span class="sd">                - &quot;Wmax&quot;: ??? [???]</span>
<span class="sd">                - &quot;Wmin&quot;: ??? [???]</span>
<span class="sd">                - &quot;Wcrit&quot;: ??? [???]</span>
<span class="sd">                - &quot;alpha&quot;: ??? [???]</span>
<span class="sd">                - &quot;Wliq&quot;: ??? [???]</span>

<span class="sd">        soil_p: soil bucket dictionary, can come from</span>
<span class="sd">            :mod:`~.params`</span>

<span class="sd">            - &quot;depth&quot;: ??? [???]</span>
<span class="sd">            - &quot;Ksat&quot;: ??? [???]</span>
<span class="sd">            - &quot;pF&quot;: Hyytiala A-horizon pF curve</span>
<span class="sd">                - &quot;ThetaS&quot;: ??? [???]</span>
<span class="sd">                - &quot;ThetaR&quot;: ??? [???]</span>
<span class="sd">                - &quot;alpha&quot;: ??? [???]</span>
<span class="sd">                - &quot;n&quot;: ??? [???]</span>
<span class="sd">            - &quot;MaxPond&quot;: ??? [???]</span>
<span class="sd">            - &quot;Wliq&quot;: ??? [???]</span>

<span class="sd">        soil_model: carbon soil model to be used</span>
<span class="sd">        tree_soil_interface: connection dictionary, connect </span>
<span class="sd">            key ``tree_pool`` to value ``soil_pool``</span>
<span class="sd">        wood_product_model: wood_product model to be used</span>
<span class="sd">        wood_product_interface: connection dictionary, connect </span>
<span class="sd">            </span>
<span class="sd">            - ``tree_pool`` : {``pool``: ``fraction``, ...} with ``pool``</span>
<span class="sd">                from soil or wood product model</span>

<span class="sd">    Attributes:</span>
<span class="sd">        z</span>
<span class="sd">        dz (float): ``z[1]-z[0]``</span>
<span class="sd">        loc</span>
<span class="sd">        ctr</span>
<span class="sd">        soil_model</span>
<span class="sd">        tree_soil_interface</span>
<span class="sd">        wood_product_model</span>
<span class="sd">        wood_product_interface</span>
<span class="sd">        trees (List[:class:`~trees.mean_tree.MeanTree`]):</span>
<span class="sd">            the trees in the stand</span>
<span class="sd">        canopywater (:class:`.productivity.waterbalance.Canopywaterbudget`): ???</span>
<span class="sd">        soil (:class:`.productivity.waterbalance.Bucket`): ???</span>
<span class="sd">        times: the times at which the stand structure was updated during\</span>
<span class="sd">            a simulation run</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">loc</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">ctr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">water_p</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="n">soil_p</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="c1">#        soil_model_class: type, #SoilCModelABC,</span>
        <span class="n">soil_model</span><span class="p">:</span> <span class="n">SoilCModelABC</span><span class="p">,</span>
        <span class="n">tree_soil_interface</span><span class="p">:</span> <span class="n">TreeSoilInterface</span><span class="p">,</span>
        <span class="n">wood_product_model</span><span class="p">:</span> <span class="n">WoodProductModelABC</span><span class="p">,</span>
        <span class="n">wood_product_interface</span><span class="p">:</span> <span class="n">WoodProductInterface</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_yearly_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_daily_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dz</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="n">loc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctr</span> <span class="o">=</span> <span class="n">ctr</span>

        <span class="c1"># create empty stand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MeanTree</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># add soil model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soil_model</span> <span class="o">=</span> <span class="n">soil_model</span>

        <span class="c1"># connect trees and soil model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_soil_interface</span> <span class="o">=</span> <span class="n">tree_soil_interface</span>

        <span class="c1"># add wood_product model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wood_product_model</span> <span class="o">=</span> <span class="n">wood_product_model</span>

        <span class="c1"># connect cut trees and soil and wood product models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wood_product_interface</span> <span class="o">=</span> <span class="n">wood_product_interface</span>

        <span class="c1"># water balance sub-model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canopywater</span> <span class="o">=</span> <span class="n">Canopywaterbudget</span><span class="p">(</span><span class="n">water_p</span><span class="p">)</span>

        <span class="c1"># soil bucket sub-model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soil</span> <span class="o">=</span> <span class="n">Bucket</span><span class="p">(</span><span class="n">soil_p</span><span class="p">)</span>

        <span class="c1"># ------ THESE ADDED 24.11.2021 / SL ---</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tdaily</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fract_of_day</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;0 yr&quot;</span><span class="p">)</span>

    <span class="c1"># OK, HERE YOU CREATE MODEL INSTANCES BUT WHERE IS THIS CALLED?</span>
    <span class="c1"># this function is called in the notebook</span>
    <span class="c1"># then trees are added based on a desired stand configuration</span>
    <span class="c1"># happens also in the notebook</span>
<div class="viewcode-block" id="Stand.create_empty"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.create_empty">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_empty</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">stand_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">wood_product_interface_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Stand</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a stand without trees.</span>

<span class="sd">        Args:</span>
<span class="sd">            stand_parameters: see :data:`.simulation_parameters.stand_params`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">stand_parameters</span>

        <span class="n">SingleTreeClass</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;SingleTreeClass&quot;</span><span class="p">]</span>
        <span class="n">soil_model</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;soil_model&quot;</span><span class="p">]</span>
        <span class="n">tree_soil_interface</span> <span class="o">=</span> <span class="n">load_tree_soil_interface</span><span class="p">(</span><span class="n">SingleTreeClass</span><span class="p">,</span> <span class="n">soil_model</span><span class="p">)</span>

        <span class="n">wood_product_model</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;wood_product_model&quot;</span><span class="p">]</span>
        <span class="n">wood_product_interface_name</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;wood_product_interface_name&quot;</span><span class="p">]</span>
        <span class="n">wood_product_interface</span> <span class="o">=</span> <span class="n">load_wood_product_interface</span><span class="p">(</span>
            <span class="n">wood_product_interface_name</span><span class="p">,</span> <span class="n">SingleTreeClass</span><span class="p">,</span> <span class="n">soil_model</span><span class="p">,</span> <span class="n">wood_product_model</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">],</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ctr&quot;</span><span class="p">],</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;water_p&quot;</span><span class="p">],</span>
            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;soil_p&quot;</span><span class="p">],</span>
            <span class="n">soil_model</span><span class="p">,</span>
            <span class="n">tree_soil_interface</span><span class="p">,</span>
            <span class="n">wood_product_model</span><span class="p">,</span>
            <span class="n">wood_product_interface</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Stand.clear_cache"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.clear_cache">[docs]</a>    <span class="k">def</span> <span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the yearly and daily caches.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_yearly_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_daily_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tree_in_stand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span></div>

    <span class="c1"># TODO: announce tree status, soil model wood product model</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))]</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;# trees: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">N_per_m2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">N_per_m2</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span> <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">current_status</span> <span class="o">!=</span> <span class="s2">&quot;waiting&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Trees per m^2: </span><span class="si">{</span><span class="n">N_per_m2</span><span class="si">:</span><span class="s2">5.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tree</span><span class="p">)]</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nr_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of MeanTrees in the stand, all statuses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nr_tree_pools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of carbon pools per MeanTree.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_trees</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The stand has no trees associated to it.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nr_pools</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nr_soil_pools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of carbon pools in the soil carbon module.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">soil_model</span><span class="o">.</span><span class="n">nr_pools</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nr_wood_product_pools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of carbon pools in the wood product module.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wood_product_model</span><span class="o">.</span><span class="n">nr_pools</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tree_pool_nrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The integer numbers of the tree pools in the whole system.</span>

<span class="sd">        Since the data set is in dims (entity, time, pool), the pools are</span>
<span class="sd">        E, B_L, C_L, ..., B_R, Litter, CWD, SOM, WP_S, WP_L.</span>
<span class="sd">        All entities have all the pools, for trees all non-tree pools contain</span>
<span class="sd">        nans, for soil, all non-soil pools contain nans, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_tree_pools</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">soil_pool_nrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The integer numbers associated to the soil module.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_tree_pools</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_tree_pools</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_soil_pools</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wood_product_pool_nrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The integer numbers associated to the wood product module.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nr_tree_pools</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_soil_pools</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nr_tree_pools</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_soil_pools</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_wood_product_pools</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tree_entity_nrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The entity numbers associated to MeanTrees.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_trees</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">soil_entity_nr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The entity number associated to the soil module.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nr_trees</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wood_product_entity_nr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The entity number associated to the wood product module.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">soil_entity_nr</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">living_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">MeanTree</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all living MeanTrees.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tree</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span> <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">is_alive</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">non_removed_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">MeanTree</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all trees with status not equal to &quot;removed&quot;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tree</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span> <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">current_status</span> <span class="o">!=</span> <span class="s2">&quot;removed&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">basal_area</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stand basal area [m2 ha-1].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Q_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;m^2/ha&quot;</span><span class="p">)</span>

        <span class="n">cross_section_areas</span> <span class="o">=</span> <span class="n">Q_</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">C_only_tree</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">dbh</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">Ns_per_ha</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">N_per_m2</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">]),</span> <span class="s2">&quot;1/m^2&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;1/ha&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">cross_section_areas</span> <span class="o">*</span> <span class="n">Ns_per_ha</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="nd">@cached_property</span><span class="p">(</span><span class="s2">&quot;_yearly_cache&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">dominant_tree_height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Average height of the tallest 100 trees [m].&quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tree</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">H</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">]</span>
        <span class="n">l</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">N_per_m2</span> <span class="o">*</span> <span class="mi">10_000</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="c1"># need to combine more MeanTrees</span>
                <span class="n">Ns</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">N_per_m2</span> <span class="o">*</span> <span class="mi">10_000</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Ns</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="c1"># less than 100 trees ha-1 in stand</span>
                    <span class="k">return</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">Hs</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
                <span class="n">nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">Ns</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">Hs</span><span class="p">[:</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">Ns</span><span class="p">[:</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="c1">#                raise NotImplementedError(&quot;We would need to combine some MeanTrees.&quot;)</span>

            <span class="k">return</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Q_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span>

    <span class="nd">@cached_property</span><span class="p">(</span><span class="s2">&quot;_yearly_cache&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">mean_tree_height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mean tree height in the stand [m].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Q_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span>

        <span class="n">num</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">H</span> <span class="o">*</span> <span class="n">tree</span><span class="o">.</span><span class="n">N_per_m2</span>
            <span class="n">denom</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">N_per_m2</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">denom</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Stand.add_trees_from_setting"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.add_trees_from_setting">[docs]</a>    <span class="k">def</span> <span class="nf">add_trees_from_setting</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">species_settings</span><span class="p">:</span> <span class="n">SpeciesSettings</span><span class="p">,</span> <span class="n">custom_species_params</span><span class="p">:</span> <span class="n">SpeciesParams</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a prescribed collection of trees to the stand.</span>

<span class="sd">        Args:</span>
<span class="sd">            species_settings: settings for different tree species</span>
<span class="sd">            custom_species_params: tree species parameters (for all species)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tree_nrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">trees</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">stand_age</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;yr&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">for</span> <span class="n">species</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">species_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#            print(species, data)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">tree_nr</span><span class="p">,</span> <span class="n">dbh</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">waiting</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">tree_nrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_nr</span><span class="p">)</span>

                <span class="n">N_per_m2</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;1/m^2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

                <span class="n">tree_age</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;yr&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">waiting</span> <span class="o">==</span> <span class="s2">&quot;waiting&quot;</span><span class="p">:</span>
                    <span class="n">first_action</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">trigger_action_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_action</span><span class="p">,</span> <span class="n">CutWaitAndReplant</span><span class="p">):</span>
                        <span class="n">tree_age</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">first_action</span><span class="o">.</span><span class="n">nr_waiting</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;yr&quot;</span><span class="p">)</span>

                    <span class="n">status_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;waiting&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">stand_age</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;waiting&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;waiting&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">stand_age</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;assigned to: [&#39;plant&#39;]&quot;</span><span class="p">]</span>

                <span class="n">single_tree</span> <span class="o">=</span> <span class="n">SingleTree</span><span class="o">.</span><span class="n">from_dbh</span><span class="p">(</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                    <span class="n">dbh</span><span class="o">=</span><span class="n">dbh</span><span class="p">,</span>
                    <span class="n">Delta_t</span><span class="o">=</span><span class="n">Q_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;yr&quot;</span><span class="p">),</span>
                    <span class="n">custom_species_params</span><span class="o">=</span><span class="n">custom_species_params</span><span class="p">,</span>
                    <span class="n">tree_age</span><span class="o">=</span><span class="n">tree_age</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">C_only_tree</span> <span class="o">=</span> <span class="n">SingleTreeCModel</span><span class="p">(</span><span class="n">single_tree</span><span class="p">)</span>
                <span class="n">nr_pools</span> <span class="o">=</span> <span class="n">C_only_tree</span><span class="o">.</span><span class="n">nr_pools</span>
                <span class="n">tree_in_stand</span> <span class="o">=</span> <span class="n">MeanTree</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">species</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                    <span class="n">C_only_tree</span><span class="o">=</span><span class="n">C_only_tree</span><span class="p">,</span>
                    <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                    <span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span>
                    <span class="n">ctr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ctr</span><span class="p">,</span>
                    <span class="n">management_strategy</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span>
                    <span class="n">base_N_per_m2</span><span class="o">=</span><span class="n">N_per_m2</span><span class="p">,</span>
                    <span class="n">status_list</span><span class="o">=</span><span class="n">status_list</span><span class="p">,</span>
                    <span class="n">N_per_m2_list</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">stand_age</span>
                    <span class="o">+</span> <span class="p">[</span><span class="n">N_per_m2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">waiting</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">],</span>
                    <span class="n">output_fluxes_list</span><span class="o">=</span><span class="p">[{}]</span> <span class="o">*</span> <span class="n">stand_age</span><span class="p">,</span>
                    <span class="n">cutting_fluxes_list</span><span class="o">=</span><span class="p">[{}]</span> <span class="o">*</span> <span class="n">stand_age</span><span class="p">,</span>
                    <span class="n">newly_planted_biomass_list</span><span class="o">=</span><span class="p">[</span><span class="n">Q_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr_pools</span><span class="p">),</span> <span class="s2">&quot;gC/m^2&quot;</span><span class="p">)]</span>
                    <span class="o">*</span> <span class="n">stand_age</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_in_stand</span><span class="p">)</span>

        <span class="c1"># permute trees such that they appear in the order as given by</span>
        <span class="c1"># the species_settings</span>
        <span class="k">for</span> <span class="n">tree_nr_index</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">tree_nrs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trees</span><span class="p">[</span><span class="n">tree_nr_index</span><span class="p">])</span></div>

    <span class="c1"># THIS IS CALLED FROM Simulation.run to:</span>
    <span class="c1"># 1) compute annual GPP of each plant, total stand GPP</span>
    <span class="c1"># 2) grow plants according to allocation models</span>
    <span class="c1"># 3) handle management actions, link stand litterfall &amp; soil carbon dynamics</span>
    <span class="c1"># 4) check the overall C balance for this year</span>

<div class="viewcode-block" id="Stand.add_final_felling"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.add_final_felling">[docs]</a>    <span class="k">def</span> <span class="nf">add_final_felling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_stand_age</span><span class="p">:</span> <span class="n">Q_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the final felling (trigger, action) pair to all trees in the stand.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_stand_age: age of stand at end of simulation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">penultimate_stand_age</span> <span class="o">=</span> <span class="n">max_stand_age</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;yr&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">tree_in_stand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="c1"># make space for the C transfer to WP</span>
            <span class="n">trigger</span> <span class="o">=</span> <span class="n">OnStandAges</span><span class="p">(</span><span class="n">stand_ages</span><span class="o">=</span><span class="p">[</span><span class="n">Q_</span><span class="p">(</span><span class="n">penultimate_stand_age</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;yr&quot;</span><span class="p">)])</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">Cut</span><span class="p">()</span>
            <span class="n">ms_item</span> <span class="o">=</span> <span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="c1"># put final felling at the beginning (highest priority)</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms_item</span><span class="p">]</span> <span class="o">+</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">management_strategy</span><span class="o">.</span><span class="n">trigger_action_list</span>  <span class="c1"># type: ignore</span>
            <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">management_strategy</span> <span class="o">=</span> <span class="n">ManagementStrategy</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>

<div class="viewcode-block" id="Stand.simulate_year"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.simulate_year">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_year</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">forcing_of_year</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">sw_model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">logfile_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run one year of model simulation, the stand is the connecting module.</span>

<span class="sd">        Args:</span>
<span class="sd">            year [yr]</span>
<span class="sd">            forcing_of_year: the forcing data frame of the simulation year</span>
<span class="sd">            sw_model_name: light model, element of [&quot;Spitters&quot;, &quot;Zhao&quot;]</span>
<span class="sd">            logfile_path: path to the logfile</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple</span>

<span class="sd">            - list with names of trees that could not be updated</span>
<span class="sd">            - GPP of the year [gC m-2 yr-1]</span>
<span class="sd">            - time: last time stamp from the forcing data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- year=</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">, stand_age=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="si">}</span><span class="s2"> ---&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">log</span><span class="p">)</span>
        <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">forcing_of_year</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">forcing_of_year</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># C in the system at the beginning of the time step</span>
        <span class="n">C_system_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_C_in_system</span><span class="p">(</span><span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;assigned to: [&#39;plant&#39;]&quot;</span><span class="p">])</span>

        <span class="c1"># clear cache before yearly computation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_yearly_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_daily_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process_cutting</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_planting</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">)</span>

        <span class="c1"># process photosynthesis</span>
        <span class="n">GPP_of_year</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;gC/m^2/yr&quot;</span><span class="p">)</span>
        <span class="c1">#        for time, row in tqdm(forcing_of_year.iterrows(), total=len(forcing_of_year)):</span>

        <span class="c1"># This calls 1/2hourly computations and accumulates stand GPP</span>
        <span class="c1"># PRINT or plot: (1) is stand lad developing correctly during the year?</span>
        <span class="c1"># (2) is stand LAI == sum(tree LAI&#39;s) at all timesteps?</span>
        <span class="c1"># (3) is tree annual maximum LAI == tree leaf_mass x tree SLA?</span>
        <span class="c1"># (4) is correct N_per_m2 assigned to to each tree?</span>
        <span class="c1"># (5) does tree below large tree absorb less PAR per unit leaf area? print:</span>
        <span class="c1">#       sum(aPAR_sl x Lsl + aPAR_sh x Lsh) / sum(Lsl + Lsh)</span>
        <span class="c1"># (6) does it photosynthesize less per unit leaf area?</span>
        <span class="c1">#      sum(An_sl x Lsl + An_sh x Lsh) / sum(Lsl + Lsh)</span>
        <span class="c1"># --&gt; did all the checks!</span>

        <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">forcing_of_year</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">forc</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span> <span class="n">forc</span><span class="p">,</span> <span class="n">sw_model_name</span><span class="p">)</span>
                <span class="n">GPP</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># STAND GPP (gC m-2 (ground) yr-1)</span>
                <span class="n">GPP_of_year</span> <span class="o">+=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">GPP</span> <span class="o">*</span> <span class="n">micromolCO2_TO_gC</span><span class="p">,</span> <span class="s2">&quot;gC/m^2/yr&quot;</span><span class="p">)</span>

        <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;GPP_of_year: </span><span class="si">{</span><span class="n">GPP_of_year</span><span class="si">:</span><span class="s2">2.4f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1">#        print(log)</span>
        <span class="c1">#        print([t.LabileC_assimilated for t in self.trees])</span>
        <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>

        <span class="c1"># IS IT HERE THE TREE GROWTH HAPPENS?</span>
        <span class="c1"># yes, here the trees grow if they are alive according to</span>
        <span class="c1"># tree_in_stand.LabileC_assimilated which was accmulated in the</span>
        <span class="c1"># half hourly run above</span>
        <span class="n">failed_tree_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_trees_update</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">)</span>

        <span class="c1"># check whether something went wrong like a tree cannot sustain itself</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_tree_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># everything okay</span>
            <span class="c1"># process soil and WPs</span>
            <span class="n">C_external_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_soil_and_WP_update</span><span class="p">()</span>

            <span class="c1"># check total mass balance</span>
            <span class="n">C_external_inputs</span> <span class="o">=</span> <span class="n">GPP_of_year</span>
            <span class="k">if</span> <span class="n">C_external_inputs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">C_external_inputs</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;gC/m^2/yr&quot;</span><span class="p">)</span>
            <span class="n">C_system_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_C_in_system</span><span class="p">()</span>

            <span class="c1"># aggregate newly planted biomass</span>
            <span class="n">C_newly_planted</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">newly_planted_biomass_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1/yr&quot;</span><span class="p">)</span>

            <span class="c1">#            print(546)</span>
            <span class="c1">#            print(C_system_pre)</span>
            <span class="c1">#            print(C_system_post)</span>
            <span class="c1">#            print(C_system_post-C_system_pre)</span>
            <span class="c1">#            print()</span>
            <span class="c1">#            print(C_external_inputs)</span>
            <span class="c1">#            print(C_external_outputs)</span>
            <span class="c1">#            print(C_newly_planted)</span>
            <span class="c1">#            print(C_external_inputs-C_external_outputs+C_newly_planted)</span>
            <span class="n">assert_accuracy</span><span class="p">(</span>
                <span class="n">C_system_post</span> <span class="o">-</span> <span class="n">C_system_pre</span><span class="p">,</span>
                <span class="p">(</span><span class="n">C_external_inputs</span> <span class="o">-</span> <span class="n">C_external_outputs</span> <span class="o">+</span> <span class="n">C_newly_planted</span><span class="p">)</span> <span class="o">*</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1 yr&quot;</span><span class="p">),</span>
                <span class="mf">1e-08</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># apply management strategies</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_process_management</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">)</span>

            <span class="n">Delta_t</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1 yr&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">+=</span> <span class="n">Delta_t</span>

        <span class="c1"># this now returns Stand-level GPP ()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">failed_tree_names</span><span class="p">,</span>
            <span class="n">GPP_of_year</span><span class="p">,</span>
            <span class="n">time</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># pylint: disable=undefined-loop-variable</span></div>

    <span class="nd">@cached_property</span><span class="p">(</span><span class="s2">&quot;_daily_cache&quot;</span><span class="p">)</span>  <span class="c1"># depends on tree&#39;s relative leaf area</span>
    <span class="k">def</span> <span class="nf">lad</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The stand&#39;s leaf area density over ``self.z``, [m2 m-3].</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            sum of the stand&#39;s trees leaf area densities\</span>
<span class="sd">            weighted by their abundance ``N_per_m2``, [m2 m-3]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">:</span>
            <span class="n">lad</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">lad</span> <span class="o">*</span> <span class="n">tree</span><span class="o">.</span><span class="n">N_per_m2</span>  <span class="c1"># m2m-3</span>

        <span class="k">return</span> <span class="n">lad</span>

    <span class="c1"># depends on lad by computation, but actually only on lad_normed</span>
    <span class="nd">@cached_property</span><span class="p">(</span><span class="s2">&quot;_yearly_cache&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">canopy_height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The stand&#39;s canopy height.</span>

<span class="sd">        Returns:</span>
<span class="sd">            highest point in the canopy where leaves can be found [m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">canopy_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">]</span>  <span class="c1"># pylint: disable=comparison-with-callable</span>

        <span class="k">return</span> <span class="n">canopy_height</span>

    <span class="nd">@cached_property</span><span class="p">(</span><span class="s2">&quot;_daily_cache&quot;</span><span class="p">)</span>  <span class="c1"># depends on lad, hence of relative_leaf_area</span>
    <span class="k">def</span> <span class="nf">LAI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stand&#39;s leaf area index [m2 (leaf) / m2 (ground)].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lad</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">)</span>

    <span class="nd">@cached_property</span><span class="p">(</span><span class="s2">&quot;_daily_cache&quot;</span><span class="p">)</span>  <span class="c1"># depends through LAI on lad</span>
    <span class="k">def</span> <span class="nf">PARalbedo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The stand&#39;s photosynthetically active radiation albedo [???].&quot;&quot;&quot;</span>
        <span class="n">PARalbedo</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">:</span>
            <span class="n">PARalbedo</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">PARalbedo</span> <span class="o">*</span> <span class="n">tree</span><span class="o">.</span><span class="n">leaf_area</span> <span class="o">*</span> <span class="n">tree</span><span class="o">.</span><span class="n">N_per_m2</span>

        <span class="k">return</span> <span class="n">PARalbedo</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">LAI</span>

    <span class="nd">@cached_property</span><span class="p">(</span><span class="s2">&quot;_daily_cache&quot;</span><span class="p">)</span>  <span class="c1"># depends through LAI on lad</span>
    <span class="k">def</span> <span class="nf">Unorm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The stand&#39;s ??? [???].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind_profile</span><span class="p">(</span><span class="n">Uo</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<div class="viewcode-block" id="Stand.run"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">forcing</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">sw_model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The half-hourly run of the photosynthesis part.</span>

<span class="sd">        run for time step ``dt``</span>

<span class="sd">        Args:</span>
<span class="sd">            dt: time step [s]</span>
<span class="sd">            forcing: forcing dictionary</span>

<span class="sd">                - doy: day of year [-]</span>
<span class="sd">                - Zen: zenith angle [rad]</span>
<span class="sd">                - dirPar: direct PAR [umolm-2s-1]</span>
<span class="sd">                - diffPar: diffuse PAR [umolm-2s-1]</span>
<span class="sd">                - Tair: air temperature [degC]</span>
<span class="sd">                - H2O: H2O mixing ratio [mol/mol]</span>
<span class="sd">                - CO2: CO2 mixing ratio [ppm]</span>
<span class="sd">                - U: wind speed at canopy top [ms-1]</span>
<span class="sd">                - Prec: precipitation rate [kg m-2 s-1]</span>
<span class="sd">                - P: air pressure [Pa]</span>

<span class="sd">            sw_model_name: light model, element of [&quot;Spitters&quot;, &quot;Zhao&quot;]</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple</span>

<span class="sd">                - GPP: ???</span>
<span class="sd">                - Gs: ???</span>
<span class="sd">                - Gs: ???</span>
<span class="sd">                - Ci: ???</span>
<span class="sd">                - E: ???</span>
<span class="sd">                - Ecan: ???</span>
<span class="sd">                - Ebl: ???</span>
<span class="sd">                - Trfall: ???</span>
<span class="sd">                - Roff: ???</span>
<span class="sd">                - Drain: ???</span>
<span class="sd">                - Infil: ???</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fract_of_day</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">/</span> <span class="mi">86400</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tdaily</span> <span class="o">+=</span> <span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;Tair&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="mi">86400</span>

        <span class="c1"># daily loop to update phenology</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fract_of_day</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># update tree phenology and leaf-area</span>
            <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">:</span>
                <span class="n">tree</span><span class="o">.</span><span class="n">update_daily</span><span class="p">(</span><span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;doy&quot;</span><span class="p">],</span> <span class="n">Tdaily</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Tdaily</span><span class="p">,</span> <span class="n">Rew</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">soil</span><span class="o">.</span><span class="n">REW</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">fract_of_day</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Tdaily</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_daily_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># solve wind profile</span>
        <span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind_profile</span><span class="p">(</span><span class="n">Uo</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># solve light absorption</span>
        <span class="n">aPar</span><span class="p">,</span> <span class="n">f_sl</span><span class="p">,</span> <span class="n">Par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">light_absorption</span><span class="p">(</span>
            <span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;Zen&quot;</span><span class="p">],</span> <span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;dirPar&quot;</span><span class="p">],</span> <span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;diffPar&quot;</span><span class="p">],</span> <span class="n">sw_model_name</span>
        <span class="p">)</span>

        <span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;f_sl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_sl</span>

        <span class="c1"># --- solve gas-exchange of trees, accumulate to stand level.</span>
        <span class="c1"># tree.LabileC_assimilated &amp; tree.LabileC_respired keep track on tree-level C-flux</span>

        <span class="n">GPP</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Gs</span><span class="p">,</span> <span class="n">Ci</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tree</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">):</span>
            <span class="c1"># CHECK THAT k matches correct element in aPar;</span>
            <span class="c1"># i.e. is the tree order here same as in self.light_absorption</span>
            <span class="c1"># --&gt; both loops go through the list self.living_trees,</span>
            <span class="c1"># so it&#39;s fine</span>
            <span class="n">forcing</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;aPar_sl&quot;</span><span class="p">:</span> <span class="n">aPar</span><span class="p">[</span><span class="s2">&quot;sunlit&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="s2">&quot;aPar_sh&quot;</span><span class="p">:</span> <span class="n">aPar</span><span class="p">[</span><span class="s2">&quot;shaded&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]})</span>

            <span class="c1"># compute Ags</span>
            <span class="c1"># A, Rd umol tree-1 s-1, fe mol tree-1 s-1, gs mol tree s-1, ci ppm</span>
            <span class="p">(</span>
                <span class="n">A</span><span class="p">,</span>
                <span class="n">Rd</span><span class="p">,</span>
                <span class="n">fe</span><span class="p">,</span>
                <span class="n">gs</span><span class="p">,</span>
                <span class="n">ci</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">compute_Ags</span><span class="p">(</span><span class="n">forcing</span><span class="p">)</span>

            <span class="c1"># update cumulative tree labile C pools: value is gC per single tree</span>
            <span class="c1"># I changed tree_in_stand.compute_Ags() so that now A is net CO2 assimilation,</span>
            <span class="c1"># i.e. photosynthesis - Rd, where Rd are respirative costs related to photosynthesis</span>
            <span class="c1"># (this should be logical, unless we cover Rd already as part of annual Rmaintenance)</span>
            <span class="c1"># --&gt; absolutely perfect, this is how we wanted to have it,</span>
            <span class="c1"># no idea why it wasn&#39;t this way</span>

            <span class="c1"># general C uptake limitation factor</span>
            <span class="c1"># can be species dependent</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">C_only_tree</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">magnitude</span>

            <span class="n">tree</span><span class="o">.</span><span class="n">LabileC_assimilated</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">micromolCO2_TO_gC</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">LabileC_respired</span> <span class="o">+=</span> <span class="n">Rd</span> <span class="o">*</span> <span class="n">micromolCO2_TO_gC</span> <span class="o">*</span> <span class="n">dt</span>

            <span class="c1"># on stand level, we should multiply them by dt (relevant ones)</span>
            <span class="n">GPP</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">tree</span><span class="o">.</span><span class="n">N_per_m2</span> <span class="o">*</span> <span class="n">dt</span>  <span class="c1"># umol m-2 timestep-1</span>
            <span class="n">E</span> <span class="o">+=</span> <span class="n">fe</span> <span class="o">*</span> <span class="n">tree</span><span class="o">.</span><span class="n">N_per_m2</span>  <span class="c1"># mol m-2 s-1</span>

            <span class="c1"># canopy conductance (mol m-2 (ground) s-1)</span>
            <span class="n">Gs</span> <span class="o">+=</span> <span class="n">gs</span> <span class="o">*</span> <span class="n">tree</span><span class="o">.</span><span class="n">N_per_m2</span>
            <span class="c1"># This could be removed if not used elsewhere in the code;</span>
            <span class="c1"># its units are arbitrary and we don&#39;t really need it</span>
            <span class="n">Ci</span> <span class="o">+=</span> <span class="n">ci</span> <span class="o">*</span> <span class="n">tree</span><span class="o">.</span><span class="n">N_per_m2</span>

        <span class="n">E</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="n">MOLAR_MASS_H2O</span>  <span class="c1"># stand transpiration rate kg m-2 (ground) s-1</span>

        <span class="c1"># --- solve canopy water balance</span>

        <span class="c1"># net radiation of ground and canopy is used to model evaporation from interception</span>
        <span class="c1"># storages. Revise later; below is Global ~2 x Par, assume 80% of absorbed becomes net.</span>
        <span class="n">Rng</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">Par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">PAR_TO_UMOL</span>
        <span class="n">Rnc</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">Par</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Par</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">PAR_TO_UMOL</span>

        <span class="n">wforc</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Rnc&quot;</span><span class="p">:</span> <span class="n">Rnc</span><span class="p">,</span>
            <span class="s2">&quot;Rng&quot;</span><span class="p">:</span> <span class="n">Rng</span><span class="p">,</span>
            <span class="s2">&quot;Tair&quot;</span><span class="p">:</span> <span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;Tair&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Prec&quot;</span><span class="p">:</span> <span class="n">forcing</span><span class="p">[</span><span class="s2">&quot;Prec&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># water fluxes kg m-2(ground) s-1</span>
        <span class="n">Trfall</span><span class="p">,</span> <span class="n">Ecan</span><span class="p">,</span> <span class="n">Ebl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canopywater</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">wforc</span><span class="p">)</span>

        <span class="c1"># compute root zone water balance</span>
        <span class="n">Infil</span><span class="p">,</span> <span class="n">Roff</span><span class="p">,</span> <span class="n">Drain</span><span class="p">,</span> <span class="n">mbe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">soil</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">rr</span><span class="o">=</span><span class="n">Trfall</span><span class="p">,</span> <span class="n">et</span><span class="o">=</span><span class="n">E</span><span class="p">,</span> <span class="n">latflow</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">GPP</span><span class="p">,</span> <span class="n">Gs</span><span class="p">,</span> <span class="n">Ci</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Ecan</span><span class="p">,</span> <span class="n">Ebl</span><span class="p">,</span> <span class="n">Trfall</span><span class="p">,</span> <span class="n">Roff</span><span class="p">,</span> <span class="n">Drain</span><span class="p">,</span> <span class="n">Infil</span></div>

    <span class="c1"># ******** Microclimate functions **********</span>
<div class="viewcode-block" id="Stand.light_absorption"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.light_absorption">[docs]</a>    <span class="k">def</span> <span class="nf">light_absorption</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">Zen</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Qb0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Qd0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sw_model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes PAR (or NIR if added) absorption within multi-layer canopy</span>

<span class="sd">        Args:</span>
<span class="sd">            Zen: zenith angle [rad]</span>
<span class="sd">            Qb0: direct light at canopy top, in our case [umol m-2 s-1]</span>
<span class="sd">            Qd0: diffuse light at canopy top, in our case [umol m-2 s-1]</span>
<span class="sd">            sw_model_name: light model, element of [&quot;Spitters&quot;, &quot;Zhao&quot;]</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple</span>

<span class="sd">            - aPAR (List[np.ndarray]): aPAR per each tree [umol m-2 (leaf) s-1]</span>
<span class="sd">            - f_sl (np.ndarray): sunlit fraction [-]</span>
<span class="sd">            - Q (float): incident PAR [umol m-2(ground) s-1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LAIz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lad</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span>

        <span class="k">if</span> <span class="n">sw_model_name</span> <span class="o">==</span> <span class="s2">&quot;Spitters&quot;</span><span class="p">:</span>
            <span class="c1"># q_sl, q_sh: absorbed light umol m-2(leaf) s-1 at each layer</span>
            <span class="n">Qb</span><span class="p">,</span> <span class="n">Qd</span><span class="p">,</span> <span class="n">Qsl</span><span class="p">,</span> <span class="n">Qsh</span><span class="p">,</span> <span class="n">q_sl</span><span class="p">,</span> <span class="n">q_sh</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">f_sl</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sw_model_Spitters</span><span class="p">(</span>
                <span class="n">LAIz</span><span class="p">,</span>
                <span class="n">Clump</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">ZEN</span><span class="o">=</span><span class="n">Zen</span><span class="p">,</span>
                <span class="n">IbSky</span><span class="o">=</span><span class="n">Qb0</span><span class="p">,</span>
                <span class="n">IdSky</span><span class="o">=</span><span class="n">Qd0</span><span class="p">,</span>
                <span class="n">LeafAlbedo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PARalbedo</span><span class="p">,</span>
                <span class="n">SoilAlbedo</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">sw_model_name</span> <span class="o">==</span> <span class="s2">&quot;Zhao&quot;</span><span class="p">:</span>

            <span class="c1"># TODO: Add parameter Clump=0.7 (clumping factor)</span>
            <span class="c1"># as input parameter instead of beign hard-coded</span>
            <span class="n">Qb</span><span class="p">,</span> <span class="n">Qd</span><span class="p">,</span> <span class="n">Qdu</span><span class="p">,</span> <span class="n">Qsl</span><span class="p">,</span> <span class="n">Qsh</span><span class="p">,</span> <span class="n">q_sl</span><span class="p">,</span> <span class="n">q_sh</span><span class="p">,</span> <span class="n">q_soil</span><span class="p">,</span> <span class="n">f_sl</span><span class="p">,</span> <span class="n">alb</span> <span class="o">=</span> <span class="n">sw_model_Zhao</span><span class="p">(</span>
                <span class="n">LAIz</span><span class="p">,</span>
                <span class="n">Clump</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">ZEN</span><span class="o">=</span><span class="n">Zen</span><span class="p">,</span>
                <span class="n">IbSky</span><span class="o">=</span><span class="n">Qb0</span><span class="p">,</span>
                <span class="n">IdSky</span><span class="o">=</span><span class="n">Qd0</span><span class="p">,</span>
                <span class="n">LeafAlbedo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PARalbedo</span><span class="p">,</span>
                <span class="n">SoilAlbedo</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown SW model&quot;</span><span class="p">)</span>

        <span class="n">aPAR</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sunlit&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;shaded&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>  <span class="c1"># absorbed by leaves</span>

        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">:</span>
            <span class="c1"># relative absorbed by each tree depends also on relative albedos</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARalbedo</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">tree</span><span class="o">.</span><span class="n">PARalbedo</span> <span class="o">+</span> <span class="n">EPS</span>
            <span class="p">)</span>  <span class="c1"># * tree.lad * tree.N_per_m2 / (self.lad + EPS)</span>
            <span class="n">aPAR</span><span class="p">[</span><span class="s2">&quot;sunlit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">q_sl</span><span class="p">)</span>  <span class="c1"># per tree, per unit leaf area</span>
            <span class="n">aPAR</span><span class="p">[</span><span class="s2">&quot;shaded&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">q_sh</span><span class="p">)</span>  <span class="c1"># per tree, unit leaf area</span>

        <span class="k">return</span> <span class="n">aPAR</span><span class="p">,</span> <span class="n">f_sl</span><span class="p">,</span> <span class="n">Qb</span> <span class="o">+</span> <span class="n">Qd</span></div>

<div class="viewcode-block" id="Stand.wind_profile"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.wind_profile">[docs]</a>    <span class="k">def</span> <span class="nf">wind_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Uo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exponential attenuation of wind within canopy of uniform leaf-area density</span>

<span class="sd">        Args:</span>
<span class="sd">            Uo: flow at canopy_height [ms-1]</span>

<span class="sd">        Returns:</span>
<span class="sd">            flow at ``self.z`` [ms-1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">LAI</span>  <span class="c1"># frontal LAI</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">Uo</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">canopy_height</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">U</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canopy_height</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uo</span>  <span class="c1"># pylint: disable=comparison-with-callable</span>

        <span class="k">return</span> <span class="n">U</span></div>

<div class="viewcode-block" id="Stand.process_cutting"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.process_cutting">[docs]</a>    <span class="k">def</span> <span class="nf">process_cutting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logfile_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cut trees that are assigned to cutting. Also do thinning.&quot;&quot;&quot;</span>
        <span class="c1"># interface of tree and wood products</span>
        <span class="n">wood_product_interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wood_product_interface</span>

        <span class="c1">#        # {tree_name: {(pool_from, pool_to): flux}}</span>
        <span class="c1">#        tree_cutting_fluxes_dict: Dict[str, Dict[tuple[str, str], Q_[float]]] = {}</span>
        <span class="k">for</span> <span class="n">tree_in_stand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="n">tree_name</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">name</span>
            <span class="n">C_only_tree</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">C_only_tree</span>
            <span class="n">new_N_per_m2</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2</span>

            <span class="n">do_cutting</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">do_thinning</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">current_status</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">current_status</span>
            <span class="k">if</span> <span class="n">current_status</span> <span class="o">==</span> <span class="s2">&quot;assigned to: [&#39;cut&#39;]&quot;</span><span class="p">:</span>
                <span class="n">do_cutting</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">N_per_m2_stored</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2</span>
                <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">status_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;removed&quot;</span>

            <span class="k">elif</span> <span class="n">current_status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;assigned to: [&#39;cut&#39;,&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">do_cutting</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">N_per_m2_stored</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2</span>

                <span class="c1"># remove &#39;cut&#39; from the list</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">current_status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">current_status</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">current_status</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&#39;cut&#39;, &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
                <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">status_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

            <span class="k">elif</span> <span class="n">current_status</span> <span class="o">==</span> <span class="s2">&quot;assigned to: [&#39;thin&#39;]&quot;</span><span class="p">:</span>
                <span class="n">do_thinning</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">status_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;thinned&quot;</span>

            <span class="k">if</span> <span class="n">do_cutting</span> <span class="ow">and</span> <span class="n">do_thinning</span><span class="p">:</span>
                <span class="n">log</span> <span class="o">=</span> <span class="s2">&quot;Ignore thinning because of cutting.&quot;</span>
                <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                <span class="n">do_thinning</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">tree_cutting_fluxes</span><span class="p">:</span> <span class="n">CuttingFluxes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">do_cutting</span><span class="p">:</span>
                <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cutting tree </span><span class="si">{</span><span class="n">tree_name</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
                <span class="n">mean_tree_cutting_fluxes</span> <span class="o">=</span> <span class="n">C_only_tree</span><span class="o">.</span><span class="n">get_cutting_fluxes</span><span class="p">(</span>
                    <span class="n">wood_product_interface</span><span class="p">,</span> <span class="n">logfile_path</span>
                <span class="p">)</span>

                <span class="n">tree_cutting_fluxes</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">*</span> <span class="n">Q_</span><span class="p">(</span><span class="n">N_per_m2_stored</span><span class="p">,</span> <span class="s2">&quot;1/m^2&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mean_tree_cutting_fluxes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tree_cutting_fluxes</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>

                <span class="n">new_N_per_m2</span> <span class="o">*=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">do_thinning</span><span class="p">:</span>
                <span class="n">N_per_m2</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2</span>  <span class="c1"># type: ignore</span>
                <span class="n">new_N_per_m2</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">_new_N_per_m2</span>  <span class="c1"># type: ignore</span>
                <span class="k">del</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">_new_N_per_m2</span>  <span class="c1"># type: ignore[attr-defined]</span>

                <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Thinning </span><span class="si">{</span><span class="n">tree_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">N_per_m2</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_N_per_m2</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>

                <span class="n">q</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">new_N_per_m2</span> <span class="o">/</span> <span class="n">N_per_m2</span>
                <span class="n">mean_tree_cutting_fluxes</span> <span class="o">=</span> <span class="n">C_only_tree</span><span class="o">.</span><span class="n">get_cutting_fluxes</span><span class="p">(</span>
                    <span class="n">wood_product_interface</span><span class="p">,</span> <span class="n">logfile_path</span>
                <span class="p">)</span>
                <span class="n">tree_cutting_fluxes</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">*</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2</span><span class="p">,</span> <span class="s2">&quot;1/m^2&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mean_tree_cutting_fluxes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tree_cutting_fluxes</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>

            <span class="c1"># always add cutting fluxes to tree&#39;s list</span>
            <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">cutting_fluxes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_cutting_fluxes</span><span class="p">)</span>

            <span class="c1"># always add N_per_m2 to tree&#39;s list</span>
            <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_N_per_m2</span><span class="p">)</span></div>

<div class="viewcode-block" id="Stand.process_planting"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.process_planting">[docs]</a>    <span class="k">def</span> <span class="nf">process_planting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logfile_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replant trees that are assigned to replanting and plant new trees.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tree_nr</span><span class="p">,</span> <span class="n">tree_in_stand</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">):</span>
            <span class="c1">#            tree_name = tree_in_stand.name</span>
            <span class="n">C_only_tree</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">C_only_tree</span>

            <span class="n">planting_action</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">current_status</span> <span class="o">==</span> <span class="s2">&quot;assigned to: [&#39;plant&#39;]&quot;</span><span class="p">:</span>
                <span class="n">planting_action</span> <span class="o">=</span> <span class="s2">&quot;do plant&quot;</span>
                <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">status_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;newly_planted&quot;</span>
            <span class="k">elif</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">current_status</span> <span class="o">==</span> <span class="s2">&quot;assigned to: [&#39;replant&#39;]&quot;</span><span class="p">:</span>
                <span class="n">planting_action</span> <span class="o">=</span> <span class="s2">&quot;do replant&quot;</span>
                <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">status_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;newly_planted&quot;</span>

            <span class="n">tree_newly_planted_biomass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C_only_tree</span><span class="o">.</span><span class="n">nr_pools</span><span class="p">),</span> <span class="s2">&quot;gC/m^2&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">planting_action</span> <span class="o">==</span> <span class="s2">&quot;do plant&quot;</span><span class="p">:</span>
                <span class="c1"># plant the tree</span>
                <span class="c1"># new tree comes with external C</span>
                <span class="c1"># take care of it in C budget</span>
                <span class="n">newly_planted_biomass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">C_only_tree</span><span class="o">.</span><span class="n">start_vector</span><span class="p">,</span> <span class="s2">&quot;gC&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">Q_</span><span class="p">(</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">base_N_per_m2</span><span class="p">,</span> <span class="s2">&quot;1/m^2&quot;</span>
                <span class="p">)</span>

                <span class="n">tree_newly_planted_biomass</span> <span class="o">+=</span> <span class="n">newly_planted_biomass</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
                <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>

                <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">base_N_per_m2</span>
                <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Planting new tree</span><span class="se">\n</span><span class="si">{</span><span class="n">tree_in_stand</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">planting_action</span> <span class="o">==</span> <span class="s2">&quot;do replant&quot;</span><span class="p">:</span>
                <span class="c1"># replant the tree</span>
                <span class="n">single_tree</span> <span class="o">=</span> <span class="n">SingleTree</span><span class="o">.</span><span class="n">from_dbh</span><span class="p">(</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">_new_species</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                    <span class="n">dbh</span><span class="o">=</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">_new_dbh</span><span class="p">,</span>  <span class="c1"># type: ignore[attr-defined]</span>
                    <span class="n">Delta_t</span><span class="o">=</span><span class="n">Q_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;yr&quot;</span><span class="p">),</span>
                    <span class="n">custom_species_params</span><span class="o">=</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">C_only_tree</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">custom_species_params</span><span class="p">,</span>
                    <span class="n">tree_age</span><span class="o">=</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">_new_tree_age</span><span class="p">,</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="p">)</span>
                <span class="k">del</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">_new_species</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="k">del</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">_new_dbh</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="k">del</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">_new_tree_age</span>  <span class="c1"># type: ignore[attr-defined]</span>

                <span class="n">new_C_only_tree</span> <span class="o">=</span> <span class="n">SingleTreeCModel</span><span class="p">(</span><span class="n">single_tree</span><span class="p">)</span>
                <span class="c1"># new tree comes with external C</span>
                <span class="c1"># take care of it in C budget</span>
                <span class="n">newly_planted_biomass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">new_C_only_tree</span><span class="o">.</span><span class="n">start_vector</span><span class="p">,</span> <span class="s2">&quot;gC&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">Q_</span><span class="p">(</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">_new_N_per_m2</span><span class="p">,</span> <span class="s2">&quot;1/m^2&quot;</span>
                <span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>

                <span class="n">new_C_only_tree</span><span class="o">.</span><span class="n">_xs</span> <span class="o">=</span> <span class="n">C_only_tree</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">new_C_only_tree</span><span class="o">.</span><span class="n">_Us</span> <span class="o">=</span> <span class="n">C_only_tree</span><span class="o">.</span><span class="n">Us</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">new_C_only_tree</span><span class="o">.</span><span class="n">_Rs</span> <span class="o">=</span> <span class="n">C_only_tree</span><span class="o">.</span><span class="n">Rs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">new_C_only_tree</span><span class="o">.</span><span class="n">_Fs</span> <span class="o">=</span> <span class="n">C_only_tree</span><span class="o">.</span><span class="n">Fs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">new_N_per_m2_list</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">_new_N_per_m2</span>  <span class="c1"># type: ignore</span>
                <span class="p">]</span>

                <span class="n">new_tree_in_stand</span> <span class="o">=</span> <span class="n">MeanTree</span><span class="p">(</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">new_C_only_tree</span><span class="p">,</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">ctr</span><span class="p">,</span>
                    <span class="c1"># take the old INSTANCES with its current values</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">management_strategy</span><span class="p">,</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">base_N_per_m2</span><span class="p">,</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">status_list</span><span class="p">,</span>
                    <span class="n">new_N_per_m2_list</span><span class="p">,</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">output_fluxes_list</span><span class="p">,</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">cutting_fluxes_list</span><span class="p">,</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">newly_planted_biomass_list</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">del</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">_new_N_per_m2</span>  <span class="c1"># type: ignore[attr-defined]</span>

                <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Replanting tree</span><span class="se">\n</span><span class="si">{</span><span class="n">new_tree_in_stand</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">[</span><span class="n">tree_nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_tree_in_stand</span>
                <span class="n">tree_in_stand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">[</span><span class="n">tree_nr</span><span class="p">]</span>

                <span class="n">tree_newly_planted_biomass</span> <span class="o">+=</span> <span class="n">newly_planted_biomass</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>

            <span class="c1"># always add newly planted biomass to tree&#39;s list</span>
            <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">newly_planted_biomass_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_newly_planted_biomass</span><span class="p">)</span></div>

    <span class="c1"># UPDATES TREE C POOLS AND GROWS TREES ONCE PER YEAR BASED ON C INPUT</span>
    <span class="c1"># and check the C balance for the single trees</span>
<div class="viewcode-block" id="Stand.process_trees_update"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.process_trees_update">[docs]</a>    <span class="k">def</span> <span class="nf">process_trees_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logfile_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the carbon models of the trees.&quot;&quot;&quot;</span>

        <span class="c1"># TREE CARBON POOLS PER TREE (gC plant-1)</span>
        <span class="c1">#</span>
        <span class="c1"># interface of tree and soil</span>
        <span class="n">tree_soil_interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_soil_interface</span>

        <span class="n">Delta_t</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1 yr&quot;</span><span class="p">)</span>
        <span class="c1"># update all trees in the stand</span>

        <span class="c1"># LOOP OVER ALL TREES IN STAND</span>
        <span class="n">failed_tree_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tree_in_stand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="n">tree_name</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">name</span>
            <span class="c1"># here is the initial state before any allocation of Labile_C_assimilated</span>
            <span class="c1"># Print these also after calling tree_in_stand.update_structure()!</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tree_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;dbh=</span><span class="si">{</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">dbh</span><span class="si">:</span><span class="s2">~2.2f</span><span class="si">}</span><span class="s2">,&quot;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;H=</span><span class="si">{</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">H</span><span class="si">:</span><span class="s2">~2.2f</span><span class="si">}</span><span class="s2">,&quot;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;C_alloc=</span><span class="si">{</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">LabileC_assimilated</span><span class="o">*</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2</span><span class="si">:</span><span class="s2">2.2f</span><span class="si">}</span><span class="s2"> gC/m2,&quot;</span>
            <span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;C_alloc_per_plant=</span><span class="si">{</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">LabileC_assimilated</span><span class="si">:</span><span class="s2">2.2f</span><span class="si">}</span><span class="s2"> gC,&quot;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;sba=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">basal_area</span><span class="si">:</span><span class="s2">~2.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;LA_plant=</span><span class="si">{</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">LA</span><span class="si">:</span><span class="s2">~2.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;max_LA_cohort=</span><span class="si">{</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">max_leaf_area</span><span class="si">:</span><span class="s2">2.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;LA_cohort=</span><span class="si">{</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">leaf_area</span><span class="si">:</span><span class="s2">5.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;N_per_m2=</span><span class="si">{</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2</span><span class="si">:</span><span class="s2">5.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">log</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>

            <span class="c1"># we try, because a tree update might fail and we have to</span>
            <span class="c1"># repeat the previous year with some management action</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># so these should be per each tree from L1433</span>
                <span class="n">N_per_m2</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2</span><span class="p">,</span> <span class="s2">&quot;1/m^2&quot;</span><span class="p">)</span>
                <span class="n">C_only_tree</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">C_only_tree</span>  <span class="c1"># type: ignore</span>
                <span class="n">old_status</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">current_status</span>

                <span class="c1"># C in the tree_in_stand before the update</span>
                <span class="n">C_tree_pre</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">C_only_tree</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">C_only_tree</span><span class="o">.</span><span class="n">stock_unit</span><span class="p">)</span> <span class="o">*</span> <span class="n">Q_</span><span class="p">(</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">N_per_m2_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;1/m^2&quot;</span>
                <span class="p">)</span>

                <span class="c1"># HERE WE MOVE FROM &quot;gC plant-1&quot; to &quot;gC m-2 (ground)</span>
                <span class="c1"># --&gt; it&#39;s also for the C balance of tree_in_stand</span>
                <span class="n">C_tree_input</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">LabileC_assimilated</span><span class="p">,</span> <span class="s2">&quot;gC/yr&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">N_per_m2</span>

                <span class="n">tree_output_fluxes</span><span class="p">:</span> <span class="n">TreeExternalOutputFluxes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">current_status</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">current_status</span>

                <span class="k">if</span> <span class="n">current_status</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;alive&quot;</span><span class="p">,</span> <span class="s2">&quot;thinned&quot;</span><span class="p">]:</span>
                    <span class="n">new_status</span> <span class="o">=</span> <span class="s2">&quot;alive&quot;</span>
                    <span class="c1"># in the end these are per tree (in glucose units) and trees are growing</span>
                    <span class="c1"># in the chain of function calls under the hood.</span>
                    <span class="c1"># note: uses object state tree_in_stand.LabileC_assimilated</span>
                    <span class="c1"># (gC plant-1) directly</span>

                    <span class="c1"># the outputs must be in gC plant-1 yr-1</span>
                    <span class="n">mean_tree_output_fluxes</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">update_structure</span><span class="p">(</span>
                        <span class="n">tree_soil_interface</span>
                    <span class="p">)</span>
                    <span class="c1"># converted to gC m-2 ground a-1; i.e. represent fluxes from the tree cohort</span>
                    <span class="n">tree_output_fluxes</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">*</span> <span class="n">N_per_m2</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mean_tree_output_fluxes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>

                <span class="k">elif</span> <span class="n">current_status</span> <span class="o">==</span> <span class="s2">&quot;newly_planted&quot;</span><span class="p">:</span>
                    <span class="n">new_status</span> <span class="o">=</span> <span class="s2">&quot;alive&quot;</span>

                    <span class="n">C_only_tree</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">C_only_tree</span><span class="o">.</span><span class="n">start_vector</span>

                    <span class="n">mean_tree_output_fluxes</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">update_structure</span><span class="p">(</span>
                        <span class="n">tree_soil_interface</span>
                    <span class="p">)</span>
                    <span class="n">tree_output_fluxes</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">*</span> <span class="n">N_per_m2</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mean_tree_output_fluxes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>

                <span class="c1">#                    # the following lines are for capturing C only in the</span>
                <span class="c1">#                    # first year; now we try to use C from x[0] in the</span>
                <span class="c1">#                    # first year, so  the tree can act regularly</span>
                <span class="c1">#                    # this conflicts with trees being removed before in the</span>
                <span class="c1">#                    # same time step, so a waiting year is required!</span>
                <span class="c1">##                    newly_planted = tree_in_stand.newly_planted_biomass_list[-1]\</span>
                <span class="c1">##                        / N_per_m2</span>
                <span class="c1">##                    C_only_tree.capture_C_only(</span>
                <span class="c1">##                        newly_planted,</span>
                <span class="c1">##                        tree_in_stand.LabileC_assimilated</span>
                <span class="c1">##                    )</span>
                <span class="c1">##                    tree_in_stand.LabileC_assimilated = 0</span>

                <span class="k">elif</span> <span class="n">current_status</span> <span class="o">==</span> <span class="s2">&quot;removed&quot;</span><span class="p">:</span>
                    <span class="n">new_status</span> <span class="o">=</span> <span class="s2">&quot;removed&quot;</span>
                    <span class="c1"># do nothing, just append dummy values to output lists</span>
                    <span class="n">C_only_tree</span><span class="o">.</span><span class="n">simulate_being_removed</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">current_status</span> <span class="o">==</span> <span class="s2">&quot;waiting&quot;</span><span class="p">:</span>
                    <span class="n">new_status</span> <span class="o">=</span> <span class="s2">&quot;waiting&quot;</span>
                    <span class="c1"># do nothing, just append dummy values to output lists</span>
                    <span class="n">C_only_tree</span><span class="o">.</span><span class="n">simulate_waiting</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">current_status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;assigned to: [&#39;wait&#39;,&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">status_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;waiting&quot;</span>
                    <span class="c1"># remove the initial &#39;wait&#39;</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">current_status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
                    <span class="n">new_status</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">current_status</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">current_status</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&#39;wait&#39;, &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="c1"># do nothing, just append dummy values to output lists</span>
                    <span class="n">C_only_tree</span><span class="o">.</span><span class="n">simulate_being_removed</span><span class="p">()</span>

                <span class="c1"># always update tree status and output fluxes</span>
                <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">status_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_status</span><span class="p">)</span>

                <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">output_fluxes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_output_fluxes</span><span class="p">)</span>

                <span class="n">C_tree_output</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tree_output_fluxes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">C_tree_output</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">C_tree_output</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">C_tree_input</span>

                <span class="n">tree_cutting_fluxes</span><span class="p">:</span> <span class="n">CuttingFluxes</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">cutting_fluxes_list</span><span class="p">[</span>
                    <span class="o">-</span><span class="mi">1</span>
                <span class="p">]</span>
                <span class="n">C_tree_cut</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tree_cutting_fluxes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">C_tree_cut</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">C_tree_cut</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">C_tree_input</span>

                <span class="n">C_tree_post</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Q_</span><span class="p">(</span><span class="n">C_only_tree</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">C_only_tree</span><span class="o">.</span><span class="n">stock_unit</span><span class="p">)</span> <span class="o">*</span> <span class="n">N_per_m2</span>
                <span class="p">)</span>

                <span class="n">tree_newly_planted</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">newly_planted_biomass_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">C_tree_newly_planted</span> <span class="o">=</span> <span class="n">tree_newly_planted</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">C_tree_newly_planted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">C_tree_newly_planted</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">C_tree_pre</span>

                <span class="k">if</span> <span class="n">old_status</span> <span class="o">==</span> <span class="s2">&quot;waiting&quot;</span><span class="p">:</span>
                    <span class="n">C_tree_pre</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">C_tree_pre</span>

                <span class="c1">#                print(1436)</span>
                <span class="c1">#                print(C_tree_pre)</span>
                <span class="c1">#                print(C_tree_post)</span>
                <span class="c1">#                print(C_tree_newly_planted)</span>
                <span class="c1">#                print(C_tree_input)</span>
                <span class="c1">#                print(C_tree_output)</span>
                <span class="c1">#                print(C_tree_cut)</span>
                <span class="c1">#                print(N_per_m2)</span>

                <span class="k">if</span> <span class="n">old_status</span> <span class="o">!=</span> <span class="s2">&quot;newly_planted&quot;</span><span class="p">:</span>
                    <span class="c1">#                    print(1205, old_status)</span>
                    <span class="c1">#                    print(tree_in_stand.name)</span>
                    <span class="c1">#                    print(C_tree_pre)</span>
                    <span class="c1">#                    print(C_tree_post)</span>
                    <span class="c1">#                    print(C_tree_input)</span>
                    <span class="c1">#                    print(C_tree_output)</span>
                    <span class="c1">#                    print(C_tree_cut)</span>
                    <span class="c1">#                    print()</span>
                    <span class="c1">#                    print(C_tree_post - C_tree_pre)</span>
                    <span class="c1">#                    print((C_tree_input - C_tree_output - C_tree_cut) * Delta_t)</span>
                    <span class="c1">#                    print()</span>
                    <span class="n">assert_accuracy</span><span class="p">(</span>
                        <span class="n">C_tree_post</span> <span class="o">-</span> <span class="n">C_tree_pre</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">C_tree_input</span> <span class="o">-</span> <span class="n">C_tree_output</span> <span class="o">-</span> <span class="n">C_tree_cut</span><span class="p">)</span> <span class="o">*</span> <span class="n">Delta_t</span><span class="p">,</span>
                        <span class="mf">1e-08</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#                    print(tree_in_stand.name)</span>
                    <span class="c1">#                    print(C_tree_pre)</span>
                    <span class="c1">#                    print(C_tree_post)</span>
                    <span class="c1">#                    print(C_tree_input)</span>
                    <span class="c1">#                    print(C_tree_output)</span>
                    <span class="n">assert_accuracy</span><span class="p">(</span>
                        <span class="n">C_tree_post</span> <span class="o">-</span> <span class="n">C_tree_newly_planted</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">C_tree_input</span> <span class="o">-</span> <span class="n">C_tree_output</span><span class="p">)</span> <span class="o">*</span> <span class="n">Delta_t</span><span class="p">,</span>
                        <span class="mf">1e-08</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="n">TreeShrinkError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="c1"># collect the failing trees and report them to</span>
                <span class="c1"># the function</span>
                <span class="n">failed_tree_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">tree_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">failed_tree_names</span></div>

<div class="viewcode-block" id="Stand.assign_emergency_action"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.assign_emergency_action">[docs]</a>    <span class="k">def</span> <span class="nf">assign_emergency_action</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tree_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">emergency_action_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">emergency_direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">emergency_q</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># fraction to keep</span>
        <span class="n">nr_of_escalation</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">logfile_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decide what to do when a tree cannot sustain itself.</span>

<span class="sd">        Args:</span>
<span class="sd">            tree_name: the name of the MeanTree that failed to be updated</span>
<span class="sd">            emergency_action_str: element of [&quot;Cut&quot;, &quot;CutWait3AndReplant&quot;, &quot;Thin&quot;, &quot;Die&quot;]</span>

<span class="sd">                - Cut: Cuts a number of trees from above or below</span>
<span class="sd">                - CutWait3AndReplant: Like &quot;Cut&quot; but with delayed replanting.</span>
<span class="sd">                - Thin: Thin the entire stand equally.</span>
<span class="sd">                - Die: Remove the unsustaibale tree.</span>

<span class="sd">            emergency_direction: ``above`` or ``below``, applies only for cutting</span>
<span class="sd">            emergency_q: Fraction of trees to keep on ``Thin``</span>
<span class="sd">            nr_of_escalation: If cutting one tree is not enough, cut two, and so on.</span>
<span class="sd">            logfile_path: path to the logfile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tree_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">]</span>
        <span class="n">tree_unsust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">[</span><span class="n">tree_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tree_name</span><span class="p">)]</span>

        <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tree_name</span><span class="si">}</span><span class="s2"> cannot sustain itself.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">log</span> <span class="o">+=</span> <span class="s2">&quot;We apply some management strategy.&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
        <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>

        <span class="c1"># thinning instead of cutting if only one living tree</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">emergency_action_str</span> <span class="o">==</span> <span class="s2">&quot;Thin&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># thin them all, intensity depends on nr_of_escalation</span>
            <span class="n">q</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">emergency_q</span><span class="o">**</span><span class="n">nr_of_escalation</span>  <span class="c1"># fraction to remove</span>
            <span class="n">emergency_action</span> <span class="o">=</span> <span class="n">Thin</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="n">selected_trees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span>

        <span class="k">elif</span> <span class="n">emergency_action_str</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Cut&quot;</span><span class="p">,</span> <span class="s2">&quot;CutWait3AndReplant&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">emergency_action_str</span> <span class="o">==</span> <span class="s2">&quot;Cut&quot;</span><span class="p">:</span>
                <span class="n">emergency_action</span> <span class="o">=</span> <span class="n">Cut</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="n">emergency_action_str</span> <span class="o">==</span> <span class="s2">&quot;CutWait3AndReplant&quot;</span><span class="p">:</span>
                <span class="n">emergency_action</span> <span class="o">=</span> <span class="n">CutWaitAndReplant</span><span class="p">(</span><span class="n">nr_waiting</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

            <span class="k">if</span> <span class="n">nr_of_escalation</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough trees to cut down for nr_of_escalation&quot;</span><span class="p">)</span>

            <span class="n">living_trees_sorted_by_height_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
                <span class="n">Q_</span><span class="o">.</span><span class="n">from_list</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">H</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="c1"># nr of trees to cut down depends on nr_of_escalation</span>
            <span class="k">if</span> <span class="n">emergency_direction</span> <span class="o">==</span> <span class="s2">&quot;above&quot;</span><span class="p">:</span>
                <span class="n">selected_living_trees_index</span> <span class="o">=</span> <span class="n">living_trees_sorted_by_height_index</span><span class="p">[</span>
                    <span class="o">-</span><span class="n">nr_of_escalation</span><span class="p">:</span>
                <span class="p">]</span>
            <span class="k">elif</span> <span class="n">emergency_direction</span> <span class="o">==</span> <span class="s2">&quot;below&quot;</span><span class="p">:</span>
                <span class="n">selected_living_trees_index</span> <span class="o">=</span> <span class="n">living_trees_sorted_by_height_index</span><span class="p">[</span>
                    <span class="p">:</span><span class="n">nr_of_escalation</span>
                <span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="mi">1403</span><span class="p">,</span> <span class="n">nr_of_escalation</span><span class="p">,</span> <span class="n">selected_living_trees_index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknwon emergency direction </span><span class="si">{</span><span class="n">emergency_direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">selected_trees</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">living_trees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected_living_trees_index</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">emergency_action_str</span> <span class="o">==</span> <span class="s2">&quot;Die&quot;</span><span class="p">:</span>
            <span class="n">emergency_action</span> <span class="o">=</span> <span class="n">Cut</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
            <span class="n">selected_trees</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree_unsust</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown emergency action </span><span class="si">{</span><span class="n">emergency_action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># assign emergency action to all selected trees</span>
        <span class="k">for</span> <span class="n">tree_in_stand</span> <span class="ow">in</span> <span class="n">selected_trees</span><span class="p">:</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="n">emergency_action</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree_in_stand</span><span class="p">)</span>
            <span class="n">new_old_status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;assigned to: </span><span class="si">{</span><span class="n">actions</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Assigning tree &#39;</span><span class="si">{</span><span class="n">tree_in_stand</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to </span><span class="si">{</span><span class="n">actions</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
            <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">status_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_old_status</span></div>

<div class="viewcode-block" id="Stand.post_process_management"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.post_process_management">[docs]</a>    <span class="k">def</span> <span class="nf">post_process_management</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logfile_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check managament strategies, assign trees for actions next year.&quot;&quot;&quot;</span>
        <span class="n">Delta_t</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1 yr&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tree_in_stand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="c1">#            tree_name = tree_in_stand.name</span>
            <span class="n">management_strategy</span> <span class="o">=</span> <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">management_strategy</span>
            <span class="n">actions</span><span class="p">,</span> <span class="n">log</span> <span class="o">=</span> <span class="n">management_strategy</span><span class="o">.</span><span class="n">post_processing_update</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">tree_in_stand</span><span class="p">,</span> <span class="n">Delta_t</span>
            <span class="p">)</span>
            <span class="c1">#            tree_in_stand.actions = actions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">):</span>
                <span class="n">write_to_logfile</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
                <span class="n">tree_in_stand</span><span class="o">.</span><span class="n">status_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;assigned to: </span><span class="si">{</span><span class="n">actions</span><span class="si">}</span><span class="s2">&quot;</span></div>

<div class="viewcode-block" id="Stand.process_soil_and_WP_update"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.process_soil_and_WP_update">[docs]</a>    <span class="k">def</span> <span class="nf">process_soil_and_WP_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transfer carbon from trees to soil and wood products.&quot;&quot;&quot;</span>
        <span class="c1"># soil and wood product pool names</span>
        <span class="n">soil_pool_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">soil_model</span><span class="o">.</span><span class="n">pool_names</span>
        <span class="n">wood_product_pool_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wood_product_model</span><span class="o">.</span><span class="n">pool_names</span>

        <span class="c1"># aggregate cutting fluxes</span>
        <span class="n">tree_cutting_fluxes_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tree</span><span class="o">.</span><span class="n">cutting_fluxes_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span>
        <span class="p">}</span>

        <span class="c1"># pool_to: flux</span>
        <span class="n">trees_cutting_fluxes_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tree_name</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tree_cutting_fluxes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">flux</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">pool_to</span> <span class="o">=</span> <span class="n">key</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pool_to</span> <span class="ow">in</span> <span class="n">trees_cutting_fluxes_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">trees_cutting_fluxes_dict</span><span class="p">[</span><span class="n">pool_to</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trees_cutting_fluxes_dict</span><span class="p">[</span><span class="n">pool_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flux</span>

        <span class="c1"># aggregate trees&#39; output fluxes</span>
        <span class="n">tree_output_fluxes_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tree</span><span class="o">.</span><span class="n">output_fluxes_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span>
        <span class="p">}</span>

        <span class="c1"># aggregate tree output fluxes</span>
        <span class="c1"># {pool_to: flux}; pool_to = None means external outflux</span>
        <span class="n">trees_output_fluxes_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tree_name</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tree_output_fluxes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">flux</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">pool_to</span> <span class="o">=</span> <span class="n">key</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pool_to</span> <span class="ow">in</span> <span class="n">trees_output_fluxes_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">trees_output_fluxes_dict</span><span class="p">[</span><span class="n">pool_to</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trees_output_fluxes_dict</span><span class="p">[</span><span class="n">pool_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flux</span>

        <span class="c1"># add soil inputs together</span>
        <span class="n">C_tree_external_outputs</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;gC/m^2/yr&quot;</span><span class="p">)</span>
        <span class="n">soil_input_fluxes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pool_to</span><span class="p">,</span> <span class="n">flux</span> <span class="ow">in</span> <span class="n">trees_output_fluxes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pool_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pool_to</span> <span class="ow">in</span> <span class="n">soil_pool_names</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown destination for tree output.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">pool_to</span> <span class="ow">in</span> <span class="n">soil_input_fluxes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">soil_input_fluxes</span><span class="p">[</span><span class="n">pool_to</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">soil_input_fluxes</span><span class="p">[</span><span class="n">pool_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flux</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">C_tree_external_outputs</span> <span class="o">+=</span> <span class="n">flux</span>

        <span class="c1"># move C from cut trees to soil and wood products</span>
        <span class="n">wood_product_input_fluxes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pool_to</span><span class="p">,</span> <span class="n">flux</span> <span class="ow">in</span> <span class="n">trees_cutting_fluxes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pool_to</span> <span class="ow">in</span> <span class="n">soil_pool_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pool_to</span> <span class="ow">in</span> <span class="n">soil_input_fluxes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">soil_input_fluxes</span><span class="p">[</span><span class="n">pool_to</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">soil_input_fluxes</span><span class="p">[</span><span class="n">pool_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flux</span>
            <span class="k">elif</span> <span class="n">pool_to</span> <span class="ow">in</span> <span class="n">wood_product_pool_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pool_to</span> <span class="ow">in</span> <span class="n">wood_product_input_fluxes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">wood_product_input_fluxes</span><span class="p">[</span><span class="n">pool_to</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wood_product_input_fluxes</span><span class="p">[</span><span class="n">pool_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flux</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid destination given for cut tree: </span><span class="si">{</span><span class="n">pool_to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># update soil model</span>
        <span class="n">soil_output_fluxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">soil_model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">soil_input_fluxes</span><span class="p">)</span>
        <span class="n">C_soil_outputs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">soil_output_fluxes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># update wood product model</span>
        <span class="n">wood_product_output_fluxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wood_product_model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">wood_product_input_fluxes</span>
        <span class="p">)</span>
        <span class="n">C_wood_product_outputs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">wood_product_output_fluxes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">C_tree_external_outputs</span> <span class="o">+</span> <span class="n">C_soil_outputs</span> <span class="o">+</span> <span class="n">C_wood_product_outputs</span></div>

<div class="viewcode-block" id="Stand.count_C_in_trees"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.count_C_in_trees">[docs]</a>    <span class="k">def</span> <span class="nf">count_C_in_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sum up all carbon in trees, ignore some tree statuses.</span>

<span class="sd">        Args:</span>
<span class="sd">            ignore: list of tree statuses to be ignored in the sum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ignore_set</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ignore_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ignore</span><span class="p">)</span>

        <span class="n">tree_stock_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">C_only_tree</span><span class="o">.</span><span class="n">stock_unit</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">Q_</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">C_only_tree</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">tree_stock_unit</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">Q_</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">N_per_m2</span><span class="p">,</span> <span class="s2">&quot;1/m^2&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span>
                <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">current_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_set</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Stand.count_C_in_system"><a class="viewcode-back" href="../../BFMM.stand.Stand.html#BFMM.stand.Stand.count_C_in_system">[docs]</a>    <span class="k">def</span> <span class="nf">count_C_in_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sum up all carbon in the system, ignore some tree statuses.</span>

<span class="sd">        Args:</span>
<span class="sd">            ignore: list of tree statuses to be ignored in the sum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_C_in_trees</span><span class="p">(</span><span class="n">ignore</span><span class="p">)</span>

        <span class="n">soil_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">soil_model</span>
        <span class="n">C_system</span> <span class="o">+=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">soil_model</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">soil_model</span><span class="o">.</span><span class="n">stock_unit</span><span class="p">)</span>

        <span class="n">WP_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wood_product_model</span>
        <span class="n">C_system</span> <span class="o">+=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">WP_model</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">WP_model</span><span class="o">.</span><span class="n">stock_unit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">C_system</span></div></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Holger Metzler, Samuli Launiainen, Giulia Vico
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>